<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DKP System - Subastas Midnight</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================================
           TEMA MIDNIGHT
           ================================ */
        :root {
            --midnight-purple: #6b2d8f;
            --midnight-blue: #1a1a3e;
            --midnight-dark: #0d0d1e;
            --midnight-accent: #9d4edd;
            --midnight-light: #c77dff;
            --glow-purple: rgba(157, 78, 221, 0.5);
            
            /* Colores de rareza WoW */
            --legendary: #ff8000;
            --epic: #a335ee;
            --rare: #0070dd;
            --uncommon: #1eff00;
        }
        
        body {
            background: linear-gradient(135deg, var(--midnight-dark) 0%, var(--midnight-blue) 50%, var(--midnight-purple) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: #e0e0e0;
        }
        
        /* Estrellas */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent);
            background-size: 200% 200%;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            opacity: 0.6;
            z-index: 0;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }
        
        * {
            position: relative;
            z-index: 1;
        }
        
        /* ================================
           NAVBAR
           ================================ */
        .navbar {
            background: linear-gradient(135deg, var(--midnight-dark) 0%, var(--midnight-purple) 100%);
            box-shadow: 0 4px 20px rgba(157, 78, 221, 0.3);
            border-bottom: 2px solid var(--midnight-accent);
        }
        
        .navbar-brand {
            color: var(--midnight-light) !important;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 0 0 10px var(--glow-purple);
        }
        
        /* ================================
           CONTENEDOR
           ================================ */
        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 15px;
        }
        
        .info-card {
            background: rgba(26, 26, 62, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(157, 78, 221, 0.2);
            border: 1px solid rgba(157, 78, 221, 0.3);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            color: var(--midnight-light);
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--glow-purple);
        }
        
        /* ================================
           TARJETAS DE SUBASTA
           ================================ */
        .auction-card {
            background: rgba(26, 26, 62, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(157, 78, 221, 0.2);
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid var(--midnight-accent);
            transition: all 0.3s ease;
        }
        
        .auction-card:hover {
            transform: translateX(5px);
            box-shadow: 0 12px 40px rgba(157, 78, 221, 0.4);
        }
        
        /* Bordes seg√∫n rareza */
        .auction-card.legendary {
            border-left-color: var(--legendary);
            box-shadow: 0 8px 32px rgba(255, 128, 0, 0.3);
        }
        
        .auction-card.legendary:hover {
            box-shadow: 0 12px 40px rgba(255, 128, 0, 0.5);
        }
        
        .auction-card.epic {
            border-left-color: var(--epic);
            box-shadow: 0 8px 32px rgba(163, 53, 238, 0.3);
        }
        
        .auction-card.epic:hover {
            box-shadow: 0 12px 40px rgba(163, 53, 238, 0.5);
        }
        
        /* Colores de rareza */
        .rarity-legendary {
            color: var(--legendary);
            font-weight: bold;
            text-shadow: 0 0 15px rgba(255, 128, 0, 0.8);
        }
        
        .rarity-epic {
            color: var(--epic);
            font-weight: bold;
            text-shadow: 0 0 15px rgba(163, 53, 238, 0.8);
        }
        
        .rarity-rare {
            color: var(--rare);
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0, 112, 222, 0.8);
        }
        
        .item-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .winner-info {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #10b981;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .bid-info {
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid rgba(157, 78, 221, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* ================================
           FILTROS
           ================================ */
        .filter-tabs .btn {
            margin-right: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--midnight-accent);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--midnight-purple) 0%, var(--midnight-accent) 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(157, 78, 221, 0.4);
        }
        
        .btn-outline-primary {
            background: transparent;
            border-color: var(--midnight-accent);
            color: var(--midnight-light);
        }
        
        .btn-outline-primary:hover {
            background: var(--midnight-accent);
            border-color: var(--midnight-accent);
            color: white;
        }
        
        .btn-outline-warning {
            border-color: var(--legendary);
            color: var(--legendary);
        }
        
        .btn-outline-warning:hover {
            background: var(--legendary);
            border-color: var(--legendary);
            color: white;
        }
        
        .btn-outline-secondary {
            border-color: var(--epic);
            color: var(--epic);
        }
        
        .btn-outline-secondary:hover {
            background: var(--epic);
            border-color: var(--epic);
            color: white;
        }
        
        /* ================================
           INPUTS
           ================================ */
        .form-control {
            background: rgba(26, 26, 62, 0.6);
            border: 1px solid var(--midnight-accent);
            color: #e0e0e0;
        }
        
        .form-control:focus {
            background: rgba(26, 26, 62, 0.8);
            border-color: var(--midnight-light);
            color: white;
            box-shadow: 0 0 10px var(--glow-purple);
        }
        
        .form-control::placeholder {
            color: #8888aa;
        }
        
        /* ================================
           BADGES
           ================================ */
        .badge {
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .bg-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
        }
        
        .bg-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        }
        
        .bg-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        }
        
        /* ================================
           ALERTAS
           ================================ */
        .alert-warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid #f59e0b;
            color: #fbbf24;
        }
        
        /* ================================
           BOT√ìN VOLVER
           ================================ */
        .btn-secondary {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.6);
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-moon"></i> Guild DKP System
                <small style="font-size: 12px; opacity: 0.7;">Midnight Edition</small>
            </a>
            
            <div class="d-flex align-items-center text-white">
                <span class="me-3" style="color: var(--midnight-light);">
                    <i class="fas fa-gavel"></i> <span id="auctionCount">0</span> subastas
                </span>
            </div>
        </div>
    </nav>
    
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-container">
        
        <!-- Bot√≥n de volver -->
        <div class="mb-3">
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
        
        <!-- Tarjeta principal -->
        <div class="info-card">
            <h3><i class="fas fa-gavel"></i> Historial de Subastas</h3>
            
            <!-- FILTROS -->
            <div class="filter-tabs">
                <button class="btn btn-primary" onclick="filtrarPorEstado('todas')">
                    Todas
                </button>
                <button class="btn btn-outline-primary" onclick="filtrarPorEstado('finalizadas')">
                    Finalizadas
                </button>
                <button class="btn btn-outline-primary" onclick="filtrarPorEstado('canceladas')">
                    Canceladas
                </button>
                <button class="btn btn-outline-warning" onclick="filtrarPorRareza('legendary')">
                    <i class="fas fa-star"></i> Legendarias
                </button>
                <button class="btn btn-outline-secondary" onclick="filtrarPorRareza('epic')">
                    <i class="fas fa-gem"></i> √âpicas
                </button>
            </div>
            
            <!-- B√∫squeda -->
            <div class="mb-3">
                <input 
                    type="text" 
                    class="form-control" 
                    id="searchInput" 
                    placeholder="üîç Buscar por nombre de objeto..."
                    onkeyup="buscarSubasta()"
                >
            </div>
        </div>
        
        <!-- LISTA DE SUBASTAS -->
        <div id="auctionsList">
            <!-- Subastas aqu√≠ -->
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="row">
            <div class="col-md-4">
                <div class="info-card text-center">
                    <h4 id="totalAuctions" style="color: var(--midnight-light);">0</h4>
                    <p class="text-muted mb-0">Total de Subastas</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-card text-center">
                    <h4 id="totalDKPSpent" style="color: var(--midnight-light);">0</h4>
                    <p class="text-muted mb-0">DKP Total Gastado</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-card text-center">
                    <h4 id="avgBid" style="color: var(--midnight-light);">0</h4>
                    <p class="text-muted mb-0">Puja Promedio</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // CONFIGURACI√ìN DEL BACKEND

        let subastasFiltradas = [];
        let subastasTodas = [];
        
        // CARGAR SUBASTAS DESDE EL BACKEND
        async function cargarSubastas() {
            try {
                const response = await fetch(`${API_URL}/auctions/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    alert('Sesi√≥n expirada');
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                
                const subastas = await response.json();
                
                subastasTodas = subastas.map(s => ({
                    id: s.id,
                    objeto: s.item_name,
                    rareza: s.item_rarity || 'epic',
                    estado: s.status,
                    pujaMinima: s.min_bid,
                    pujaGanadora: s.winning_bid || 0,
                    ganador: s.winner ? s.winner.characterName : null,
                    ganadorClase: s.winner ? s.winner.characterClass : null,
                    fecha: s.created_at,
                    totalPujas: s.bid_count || 0
                }));
                
                subastasFiltradas = [...subastasTodas];
                renderizarSubastas(subastasFiltradas);
                calcularEstadisticas();
                actualizarContador();
                
            } catch (error) {
                console.error('Error cargando subastas:', error);
                document.getElementById('auctionsList').innerHTML = `
                    <div class="info-card text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error: No se pudo conectar con el servidor.<br>
                        Verifica que el backend est√© corriendo en ${API_URL}
                    </div>
                `;
            }
        }
                ganadorClase: 'Priest',
                fecha: '2025-01-11 22:15:00',
                totalPujas: 4
            }
        ];
        
        let subastasFiltradas = [...subastasTodas];
        
        function renderizarSubastas(subastas) {
            const contenedor = document.getElementById('auctionsList');
            
            if (subastas.length === 0) {
                contenedor.innerHTML = `
                    <div class="info-card text-center">
                        <p style="color: #8888aa;">No se encontraron subastas con esos filtros</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            subastas.forEach(subasta => {
                const claseRareza = `rarity-${subasta.rareza}`;
                const claseBorde = subasta.rareza;
                
                const fecha = new Date(subasta.fecha);
                const fechaTexto = fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let infoFinal = '';
                if (subasta.estado === 'finalizada') {
                    infoFinal = `
                        <div class="winner-info">
                            <strong><i class="fas fa-trophy"></i> Ganador:</strong> 
                            ${subasta.ganador} (${subasta.ganadorClase})
                            <br>
                            <strong><i class="fas fa-coins"></i> Puja ganadora:</strong> 
                            <span style="color: #f87171; text-shadow: 0 0 10px rgba(248, 113, 113, 0.5);">${subasta.pujaGanadora} DKP</span>
                        </div>
                    `;
                } else if (subasta.estado === 'cancelada') {
                    infoFinal = `
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-ban"></i> Subasta cancelada - No hubo ganador
                        </div>
                    `;
                }
                
                html += `
                    <div class="auction-card ${claseBorde}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="item-name ${claseRareza}">
                                    <i class="fas fa-cube"></i> ${subasta.objeto}
                                </div>
                                <p class="mb-1">
                                    <small style="color: #8888aa;">
                                        <i class="far fa-calendar-alt"></i> ${fechaTexto}
                                    </small>
                                </p>
                                <div class="bid-info">
                                    <strong>Puja m√≠nima:</strong> ${subasta.pujaMinima} DKP | 
                                    <strong>Total de pujas:</strong> ${subasta.totalPujas}
                                </div>
                                ${infoFinal}
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${subasta.rareza === 'legendary' ? 'bg-warning' : 'bg-secondary'} mb-2">
                                    ${subasta.rareza === 'legendary' ? '‚≠ê Legendaria' : 'üíé √âpica'}
                                </span>
                                <br>
                                <span class="badge ${subasta.estado === 'finalizada' ? 'bg-success' : 'bg-warning'}">
                                    ${subasta.estado === 'finalizada' ? '‚úì Finalizada' : '‚úó Cancelada'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function filtrarPorEstado(estado) {
            document.querySelectorAll('.filter-tabs .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');
            
            if (estado === 'todas') {
                subastasFiltradas = [...subastasTodas];
            } else {
                subastasFiltradas = subastasTodas.filter(s => s.estado === estado);
            }
            
            renderizarSubastas(subastasFiltradas);
            actualizarContador();
            console.log(`üîç Filtrado: ${estado}`);
        }
        
        function filtrarPorRareza(rareza) {
            subastasFiltradas = subastasTodas.filter(s => s.rareza === rareza);
            renderizarSubastas(subastasFiltradas);
            actualizarContador();
            console.log(`üîç Filtrado: ${rareza}`);
        }
        
        function buscarSubasta() {
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            subastasFiltradas = subastasTodas.filter(s => 
                s.objeto.toLowerCase().includes(busqueda)
            );
            renderizarSubastas(subastasFiltradas);
            actualizarContador();
        }
        
        function actualizarContador() {
            document.getElementById('auctionCount').textContent = subastasFiltradas.length;
        }
        
        function calcularEstadisticas() {
            const total = subastasTodas.length;
            const finalizadas = subastasTodas.filter(s => s.estado === 'finalizada');
            const totalDKP = finalizadas.reduce((sum, s) => sum + s.pujaGanadora, 0);
            const promedio = finalizadas.length > 0 ? Math.round(totalDKP / finalizadas.length) : 0;
            
            document.getElementById('totalAuctions').textContent = total;
            document.getElementById('totalDKPSpent').textContent = totalDKP.toLocaleString();
            document.getElementById('avgBid').textContent = promedio;
        }
        
        window.addEventListener('load', function() {
            console.log('%cüåô MIDNIGHT THEME - AUCTIONS', 'color: #c77dff; font-size: 18px; font-weight: bold');
            console.log('üì° Cargando subastas desde el backend...');
            cargarSubastas();
        });
    </script>
</body>
</html>
