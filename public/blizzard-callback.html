<!DOCTYPE html>
<html>
<head>
  <title>Blizzard Character Import</title>
  <style>
    body { background: #1a1a2e; color: #e0e0e0; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .msg { text-align: center; }
    .spinner { border: 3px solid #333; border-top: 3px solid #00aeff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg) } }
  </style>
</head>
<body>
  <div class="msg">
    <div class="spinner"></div>
    <p id="status">Importing characters...</p>
    <p style="font-size:12px;color:#888;" id="hint">This window will close automatically.</p>
  </div>
  <script>
    (function() {
      var statusEl = document.getElementById('status');
      var hintEl = document.getElementById('hint');

      function showError(msg) {
        statusEl.textContent = msg;
        hintEl.textContent = 'You can close this window.';
        var spinner = document.querySelector('.spinner');
        if (spinner) spinner.style.display = 'none';
      }

      // Decode base64url to UTF-8 string (atob only handles Latin-1, not multi-byte UTF-8)
      function fromBase64Url(str) {
        var b64 = str.replace(/-/g, '+').replace(/_/g, '/');
        while (b64.length % 4) b64 += '=';
        var binary = atob(b64);
        var bytes = new Uint8Array(binary.length);
        for (var i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return new TextDecoder().decode(bytes);
      }

      try {
        // Read data from URL hash: #data=base64urlstring
        var hash = window.location.hash.substring(1);
        var eqIndex = hash.indexOf('=');
        var encoded = eqIndex !== -1 ? hash.substring(eqIndex + 1) : '';

        if (!encoded) {
          showError('No character data received.');
          return;
        }

        var data = JSON.parse(fromBase64Url(encoded));

        if (data.error) {
          showError(data.error);
          return;
        }

        // Same-origin postMessage to parent window (guaranteed to work)
        if (window.opener) {
          window.opener.postMessage({ type: 'blizzard-characters', data: data }, window.location.origin);
          setTimeout(function() { window.close(); }, 1500);
        } else {
          showError('Could not communicate with parent window. Please close this window and try again.');
        }
      } catch(e) {
        showError('Error: ' + e.message);
      }
    })();
  </script>
</body>
</html>
