<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DKP System - Midnight Edition</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Cinzel -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Translations -->
    <script src="translations.js"></script>
    
    <style>
        /* ================================
           PALETA MIDNIGHT
           ================================ */
        :root {
            --midnight-deepblue: #0a0e27;
            --midnight-spaceblue: #1a1d3a;
            --midnight-purple: #4a1a8f;
            --midnight-bright-purple: #8b5cf6;
            --midnight-glow: #a78bfa;
            --midnight-silver: #e0e7ff;
            --midnight-accent: #6d28d9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f0a1e 50%, #000000 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: var(--midnight-silver);
            overflow-x: hidden;
        }
        
        /* Efecto nebulosa */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(109, 40, 217, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(74, 26, 143, 0.1) 0%, transparent 50%);
            animation: nebula 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes nebula {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
            50% { transform: translate(-5%, 5%) scale(1.1); opacity: 0.7; }
        }
        
        /* Estrellas */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 33% 75%, white, transparent),
                radial-gradient(2px 2px at 15% 85%, white, transparent),
                radial-gradient(1px 1px at 70% 25%, white, transparent);
            background-size: 200% 200%;
            animation: starsTwinkle 10s ease-in-out infinite;
            pointer-events: none;
            opacity: 0.8;
            z-index: 0;
        }
        
        @keyframes starsTwinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }
        
        * {
            position: relative;
            z-index: 1;
        }
        
        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(74, 26, 143, 0.9) 100%);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.4);
            border-bottom: 2px solid var(--midnight-bright-purple);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-family: 'Cinzel', serif;
            color: var(--midnight-silver) !important;
            font-weight: 700;
            font-size: 28px;
            text-shadow: 
                0 0 10px rgba(167, 139, 250, 0.8),
                0 0 20px rgba(139, 92, 246, 0.6),
                0 0 30px rgba(109, 40, 217, 0.4);
            letter-spacing: 2px;
        }
        
        .navbar-brand small {
            font-family: 'Arial', sans-serif;
            font-size: 11px;
            opacity: 0.8;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connection-status.connected {
            background: #34d399;
            box-shadow: 0 0 10px #34d399;
        }
        
        .connection-status.disconnected {
            background: #f87171;
        }

        /* Language selector */
        .btn-group .btn.active {
            background-color: var(--midnight-bright-purple);
            border-color: var(--midnight-bright-purple);
            color: white;
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 15px;
        }
        
        .info-card {
            background: rgba(10, 14, 39, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(139, 92, 246, 0.15),
                inset 0 0 60px rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 30px;
            margin-bottom: 25px;
            transition: all 0.4s ease;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.6),
                0 0 60px rgba(139, 92, 246, 0.3),
                inset 0 0 80px rgba(139, 92, 246, 0.1);
            border-color: var(--midnight-bright-purple);
        }
        
        .info-card h3 {
            font-family: 'Cinzel', serif;
            color: var(--midnight-glow);
            margin-bottom: 25px;
            font-size: 22px;
            text-shadow: 0 0 15px rgba(167, 139, 250, 0.6);
            letter-spacing: 1px;
        }
        
        .info-card p {
            color: #c7d2fe;
            line-height: 1.8;
            margin-bottom: 12px;
        }
        
        .info-card strong {
            color: var(--midnight-glow);
            text-shadow: 0 0 5px rgba(167, 139, 250, 0.4);
        }
        
        /* Pesta침as */
        .nav-tabs {
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            margin-bottom: 30px;
        }
        
        .nav-tabs .nav-link {
            font-family: 'Cinzel', serif;
            color: #c7d2fe;
            background: transparent;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--midnight-glow);
            background: rgba(139, 92, 246, 0.1);
            border-bottom-color: rgba(139, 92, 246, 0.5);
        }
        
        .nav-tabs .nav-link.active {
            color: white;
            background: linear-gradient(135deg, rgba(74, 26, 143, 0.3) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-bottom: 3px solid var(--midnight-bright-purple);
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.8);
        }
        
        .nav-tabs .nav-link i {
            margin-right: 8px;
        }
        
        /* Badge DKP */
        .dkp-badge {
            background: linear-gradient(135deg, 
                rgba(109, 40, 217, 0.9) 0%, 
                rgba(139, 92, 246, 0.9) 50%,
                rgba(167, 139, 250, 0.9) 100%);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(139, 92, 246, 0.5),
                0 0 60px rgba(167, 139, 250, 0.4),
                inset 0 0 80px rgba(255, 255, 255, 0.1);
            border: 2px solid var(--midnight-bright-purple);
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .dkp-badge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 70%
            );
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .dkp-badge:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 
                0 12px 48px rgba(139, 92, 246, 0.7),
                0 0 80px rgba(167, 139, 250, 0.6),
                inset 0 0 100px rgba(255, 255, 255, 0.15);
        }
        
        .dkp-badge h4 {
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 18px;
            color: #e0e7ff;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
        
        .dkp-badge .dkp-amount {
            font-family: 'Cinzel', serif;
            font-size: 56px;
            font-weight: 700;
            color: white;
            margin: 15px 0;
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(167, 139, 250, 0.6),
                0 0 60px rgba(139, 92, 246, 0.4);
            letter-spacing: 2px;
        }
        
        /* Transacciones */
        .transaction-row {
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            padding: 15px 0;
            transition: all 0.3s ease;
        }
        
        .transaction-row:hover {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            padding-left: 15px;
            border-bottom-color: var(--midnight-bright-purple);
        }
        
        .transaction-row:last-child {
            border-bottom: none;
        }
        
        .amount-positive {
            color: #34d399;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.6);
        }
        
        .amount-negative {
            color: #f87171;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(248, 113, 113, 0.6);
        }
        
        /* Colores de clases WoW */
        .class-warrior { color: #C79C6E; font-weight: bold; text-shadow: 0 0 10px rgba(199, 156, 110, 0.7); }
        .class-paladin { color: #F58CBA; font-weight: bold; text-shadow: 0 0 10px rgba(245, 140, 186, 0.7); }
        .class-hunter { color: #ABD473; font-weight: bold; text-shadow: 0 0 10px rgba(171, 212, 115, 0.7); }
        .class-rogue { color: #FFF569; font-weight: bold; text-shadow: 0 0 10px rgba(255, 245, 105, 0.7); }
        .class-priest { color: #FFFFFF; font-weight: bold; text-shadow: 0 0 15px rgba(255, 255, 255, 0.9); }
        .class-shaman { color: #0070DE; font-weight: bold; text-shadow: 0 0 10px rgba(0, 112, 222, 0.7); }
        .class-mage { color: #69CCF0; font-weight: bold; text-shadow: 0 0 10px rgba(105, 204, 240, 0.7); }
        .class-warlock { color: #9482C9; font-weight: bold; text-shadow: 0 0 10px rgba(148, 130, 201, 0.7); }
        .class-druid { color: #FF7D0A; font-weight: bold; text-shadow: 0 0 10px rgba(255, 125, 10, 0.7); }
        .class-death-knight { color: #C41F3B; font-weight: bold; text-shadow: 0 0 10px rgba(196, 31, 59, 0.7); }
        .class-demon-hunter { color: #A330C9; font-weight: bold; text-shadow: 0 0 10px rgba(163, 48, 201, 0.7); }
        .class-monk { color: #00FF96; font-weight: bold; text-shadow: 0 0 10px rgba(0, 255, 150, 0.7); }
        
        .alert {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid var(--midnight-bright-purple);
            color: #e0e7ff;
            backdrop-filter: blur(10px);
        }
        
        .alert-success {
            background: rgba(52, 211, 153, 0.15);
            border-color: #34d399;
            color: #a7f3d0;
        }
        
        .badge {
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        .bg-primary {
            background: linear-gradient(135deg, var(--midnight-purple) 0%, var(--midnight-bright-purple) 100%) !important;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--midnight-purple) 0%, var(--midnight-bright-purple) 100%);
            border: none;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.6);
            background: linear-gradient(135deg, var(--midnight-bright-purple) 0%, var(--midnight-glow) 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #34d399 100%);
            border: none;
            box-shadow: 0 4px 20px rgba(52, 211, 153, 0.4);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(52, 211, 153, 0.6);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--midnight-deepblue);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--midnight-purple) 0%, var(--midnight-bright-purple) 100%);
            border-radius: 6px;
            border: 2px solid var(--midnight-deepblue);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--midnight-bright-purple) 0%, var(--midnight-glow) 100%);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--midnight-glow);
        }
        
        .loading i {
            font-size: 48px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            gap: 15px;
        }

        .calendar-day-card {
            background: rgba(138, 92, 246, 0.1);
            border: 1px solid rgba(138, 92, 246, 0.3);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .calendar-day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 92, 246, 0.3);
        }

        /* DKP Progress Container */
        .dkp-progress-container {
            background: rgba(138, 92, 246, 0.15);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(138, 92, 246, 0.3);
        }

        /* OPCI칍N 1: Vista Semanal (Week View) */
        .week-view-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .week-days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .week-day-card {
            background: linear-gradient(135deg, rgba(138, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
            border: 2px solid rgba(138, 92, 246, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.4s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .week-day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.05));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .week-day-card:hover::before {
            opacity: 1;
        }

        .week-day-card.confirmed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.1));
            border-color: rgba(34, 197, 94, 0.6);
        }

        .week-day-card.declined {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.1));
            border-color: rgba(239, 68, 68, 0.6);
        }

        .week-day-card.tentative {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.25), rgba(251, 191, 36, 0.1));
            border-color: rgba(251, 191, 36, 0.6);
        }

        .week-day-badge {
            display: inline-block;
            background: var(--midnight-bright-purple);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .week-day-icon {
            font-size: 4rem;
            margin: 20px 0;
            opacity: 0.3;
            transition: all 0.3s;
        }

        .week-day-card.confirmed .week-day-icon {
            opacity: 1;
            color: #22c55e;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .week-day-card.declined .week-day-icon {
            opacity: 1;
            color: #ef4444;
        }

        .week-day-card.tentative .week-day-icon {
            opacity: 1;
            color: #fbbf24;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px currentColor); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 15px currentColor); }
        }

        .week-day-status {
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 15px;
            color: var(--midnight-glow);
        }

        .week-day-dkp-badge {
            display: inline-block;
            background: linear-gradient(90deg, var(--midnight-bright-purple), var(--midnight-glow));
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            font-weight: bold;
        }

        /* OPCI칍N 2: Vista Tarjetas (Card View) */
        .card-view-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .raid-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .raid-day-card {
            background: rgba(138, 92, 246, 0.1);
            border: 2px solid rgba(138, 92, 246, 0.3);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }

        .raid-day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(138, 92, 246, 0.4);
        }

        .raid-card-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(138, 92, 246, 0.3);
        }

        .raid-day-badge-large {
            display: inline-block;
            background: linear-gradient(135deg, var(--midnight-bright-purple), var(--midnight-glow));
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .raid-time-display {
            font-size: 1.1rem;
            color: var(--midnight-silver);
            margin-top: 10px;
        }

        .raid-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .raid-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(138, 92, 246, 0.2);
            color: white;
        }

        .raid-action-btn:hover {
            transform: scale(1.05);
        }

        .raid-action-btn.btn-confirm {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.1));
            border-color: rgba(34, 197, 94, 0.6);
        }

        .raid-action-btn.btn-confirm:hover,
        .raid-action-btn.btn-confirm.active {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.6), rgba(34, 197, 94, 0.3));
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .raid-action-btn.btn-decline {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1));
            border-color: rgba(239, 68, 68, 0.6);
        }

        .raid-action-btn.btn-decline:hover,
        .raid-action-btn.btn-decline.active {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.6), rgba(239, 68, 68, 0.3));
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .raid-action-btn.btn-tentative {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(251, 191, 36, 0.1));
            border-color: rgba(251, 191, 36, 0.6);
        }

        .raid-action-btn.btn-tentative:hover,
        .raid-action-btn.btn-tentative.active {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.6), rgba(251, 191, 36, 0.3));
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .dkp-indicator {
            display: inline-block;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Admin Attendance Table */
        .attendance-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .attendance-table th {
            background: rgba(138, 92, 246, 0.3);
            padding: 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid var(--midnight-bright-purple);
        }

        .attendance-table td {
            background: rgba(138, 92, 246, 0.1);
            padding: 12px 15px;
            border-bottom: 1px solid rgba(138, 92, 246, 0.2);
        }

        .attendance-table tr:hover td {
            background: rgba(138, 92, 246, 0.2);
        }

        .attendance-icon {
            font-size: 1.5rem;
            text-align: center;
        }

        .attendance-icon.confirmed {
            color: #22c55e;
        }

        .attendance-icon.declined {
            color: #ef4444;
        }

        .attendance-icon.tentative {
            color: #fbbf24;
        }

        .attendance-icon.no-response {
            color: #6b7280;
            opacity: 0.5;
        }

        .notes-input {
            background: rgba(138, 92, 246, 0.15);
            border: 1px solid rgba(138, 92, 246, 0.3);
            border-radius: 6px;
            padding: 8px;
            color: white;
            width: 100%;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--midnight-bright-purple);
            box-shadow: 0 0 10px rgba(138, 92, 246, 0.4);
        }

        .calendar-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(138, 92, 246, 0.2);
        }

        .calendar-day-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--midnight-glow);
        }

        .calendar-raid-time {
            font-size: 0.9rem;
            color: var(--midnight-silver);
            opacity: 0.8;
        }

        .availability-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .availability-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .availability-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .availability-btn.confirmed {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }

        .availability-btn.declined {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .availability-btn.tentative {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .availability-btn.active {
            font-weight: bold;
            box-shadow: 0 0 15px currentColor;
        }

        .calendar-notes {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 92, 246, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 0.9rem;
        }

        .calendar-notes::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .week-overview-grid {
            overflow-x: auto;
        }

        .week-overview-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        .week-overview-table th {
            background: rgba(138, 92, 246, 0.3);
            padding: 10px;
            text-align: left;
            font-size: 0.9rem;
        }

        .week-overview-table td {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            font-size: 0.85rem;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .status-badge.confirmed {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .status-badge.declined {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .status-badge.tentative {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .status-badge.no-response {
            background: rgba(156, 163, 175, 0.3);
            color: #9ca3af;
        }

        .day-summary {
            text-align: center;
            padding: 15px;
            background: rgba(138, 92, 246, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .summary-count {
            font-size: 2rem;
            font-weight: bold;
            color: var(--midnight-glow);
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--midnight-silver);
            opacity: 0.8;
        }

        /* Custom Modal System */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .custom-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-modal {
            background: linear-gradient(135deg, #1a1d3a 0%, #0a0e27 100%);
            border: 2px solid var(--midnight-bright-purple);
            border-radius: 15px;
            padding: 0;
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(138, 92, 246, 0.4);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .custom-modal-header {
            background: linear-gradient(90deg, var(--midnight-purple), var(--midnight-bright-purple));
            padding: 20px 25px;
            border-bottom: 1px solid var(--midnight-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        .custom-modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .custom-modal-close:hover {
            opacity: 1;
        }

        .custom-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .custom-modal-footer {
            padding: 20px 25px;
            border-top: 1px solid rgba(138, 92, 246, 0.3);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group-modal {
            margin-bottom: 20px;
        }

        .form-group-modal label {
            display: block;
            margin-bottom: 8px;
            color: var(--midnight-glow);
            font-weight: 500;
        }

        .form-group-modal input,
        .form-group-modal select,
        .form-group-modal textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 92, 246, 0.5);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .form-group-modal input:focus,
        .form-group-modal select:focus,
        .form-group-modal textarea:focus {
            outline: none;
            border-color: var(--midnight-bright-purple);
            box-shadow: 0 0 10px rgba(138, 92, 246, 0.3);
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--midnight-glow);
        }

        .item-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(138, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .item-category {
            background: rgba(138, 92, 246, 0.2);
            padding: 10px 15px;
            font-weight: bold;
            color: var(--midnight-glow);
            border-bottom: 1px solid rgba(138, 92, 246, 0.3);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-category:hover {
            background: rgba(138, 92, 246, 0.3);
        }

        .item-entry {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(138, 92, 246, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-entry:hover {
            background: rgba(138, 92, 246, 0.2);
        }

        .item-entry.selected {
            background: rgba(138, 92, 246, 0.4);
            border-left: 3px solid var(--midnight-bright-purple);
        }

        .item-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid rgba(138, 92, 246, 0.5);
        }

        .item-name {
            flex: 1;
        }

        .item-rarity-legendary {
            color: #ff8000;
        }

        .item-rarity-epic {
            color: #a335ee;
        }

        .item-rarity-rare {
            color: #0070dd;
        }

        .item-rarity-uncommon {
            color: #1eff00;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auction-accordion {
            margin-bottom: 15px;
        }

        .auction-header {
            background: rgba(138, 92, 246, 0.2);
            padding: 15px 20px;
            border: 1px solid rgba(138, 92, 246, 0.3);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .auction-header:hover {
            background: rgba(138, 92, 246, 0.3);
        }

        .auction-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }

        .auction-body {
            display: none;
            padding: 20px;
            border: 1px solid rgba(138, 92, 246, 0.3);
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .auction-body.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-moon"></i> Pew Pew Kittens with Guns
                <br>
                <small>Midnight Edition</small>
            </a>
            
            <div class="d-flex align-items-center text-white">
                <div class="dropdown me-2">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user"></i> <span id="username">Cargando...</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#" onclick="showMyCharacterTab(); return false;">
                            <i class="fas fa-user-shield"></i> <span data-i18n="my_character">Mi Personaje</span>
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout(); return false;">
                            <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Salir</span>
                        </a></li>
                    </ul>
                </div>
                <div class="dropdown me-2">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="currentFlag">游쀯릖</span> <span id="currentLangName">Espa침ol</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                        <li><a class="dropdown-item" href="#" onclick="changeLanguage('es'); return false;">游쀯릖 Espa침ol</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeLanguage('en'); return false;">游섫릖 English</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-container">
        
        <!-- PESTA칌AS -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation" style="display: none;">
                <button class="nav-link" id="personaje-tab" data-bs-toggle="tab" data-bs-target="#personaje" type="button">
                    <i class="fas fa-user-shield"></i> <span data-i18n="my_character">Mi Personaje</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="miembros-tab" data-bs-toggle="tab" data-bs-target="#miembros" type="button">
                    <i class="fas fa-users"></i> <span data-i18n="members">Miembros</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="subasta-tab" data-bs-toggle="tab" data-bs-target="#subasta" type="button">
                    <i class="fas fa-gavel"></i> <span data-i18n="active_auction">Subasta Activa</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button">
                    <i class="fas fa-history"></i> <span data-i18n="auction_history">Historial de Subastas</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendario-tab" data-bs-toggle="tab" data-bs-target="#calendario" type="button">
                    <i class="fas fa-calendar-alt"></i> <span data-i18n="calendar">Calendario</span>
                </button>
            </li>
            <li class="nav-item" role="presentation" id="admin-tab-item" style="display: none;">
                <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button">
                    <i class="fas fa-crown"></i> <span data-i18n="admin">Admin</span>
                </button>
            </li>
        </ul>
        
        <!-- CONTENIDO DE LAS PESTA칌AS -->
        <div class="tab-content" id="myTabContent">
            
            <!-- PESTA칌A 1: MI PERSONAJE -->
            <div class="tab-pane fade show active" id="personaje" role="tabpanel">
                <div class="row fade-in">
                    <div class="col-md-6">
                        <div class="info-card">
                            <h3><i class="fas fa-user-shield"></i> <span data-i18n="information">Informaci칩n</span></h3>
                            <div id="characterInfo"></div>
                        </div>

                        <div class="info-card">
                            <h3><i class="fas fa-chart-line"></i> <span data-i18n="statistics">Estad칤sticas</span></h3>
                            <div id="statsInfo"></div>
                        </div>

                        <div class="info-card">
                            <h3><i class="fas fa-lock"></i> <span data-i18n="security">Seguridad</span></h3>
                            <button class="btn btn-outline-light btn-sm w-100" onclick="showChangePasswordModal()">
                                <i class="fas fa-key"></i> <span data-i18n="change_password">Cambiar Contrase침a</span>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="info-card">
                            <div class="dkp-badge" onclick="animateDKP()">
                                <h4 data-i18n="current_dkp">DKP ACTUAL</h4>
                                <div class="dkp-amount" id="currentDKP">-</div>
                                <small style="color: #e0e7ff;" data-i18n="dragon_kill_points">Dragon Kill Points</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial personal de DKP -->
                <div class="row fade-in mt-3">
                    <div class="col-md-12">
                        <div class="info-card">
                            <h3><i class="fas fa-file-invoice"></i> <span data-i18n="my_dkp_history">Mi Historial de DKP</span></h3>
                            <div id="transactionsList"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PESTA칌A 2: MIEMBROS -->
            <div class="tab-pane fade" id="miembros" role="tabpanel">
                <div class="row fade-in">
                    <div class="col-md-12">
                        <div class="info-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="mb-0"><i class="fas fa-users"></i> <span data-i18n="members_list">Miembros del Guild</span></h3>
                                <button class="btn btn-success" onclick="showAddMemberModal()" id="btnAddMember" style="display: none;">
                                    <i class="fas fa-user-plus"></i> <span data-i18n="add_member">A침adir Miembro</span>
                                </button>
                            </div>
                            <div id="membersList"><span data-i18n="loading">Cargando...</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA칌A 3: SUBASTA ACTIVA -->
            <div class="tab-pane fade" id="subasta" role="tabpanel">
                <div class="row fade-in">
                    <div class="col-md-12">
                        <div class="info-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="mb-0"><i class="fas fa-gavel"></i> <span data-i18n="active_auction_title">Subasta Activa</span></h3>
                                <button class="btn btn-primary" onclick="showCreateAuctionModal()" id="btnCreateAuction" style="display: none;">
                                    <i class="fas fa-plus-circle"></i> <span data-i18n="create_auction">Crear Subasta</span>
                                </button>
                            </div>
                            <div id="auctionContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA칌A 4: HISTORIAL DE SUBASTAS -->
            <div class="tab-pane fade" id="historial" role="tabpanel">
                <div class="row fade-in">
                    <div class="col-md-12">
                        <div class="info-card">
                            <h3><i class="fas fa-history"></i> <span data-i18n="auction_history_title">Historial de Subastas</span></h3>
                            <div id="auctionsHistoryList"><span data-i18n="loading">Cargando...</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA칌A 5: CALENDARIO -->
            <div class="tab-pane fade" id="calendario" role="tabpanel">
                <div class="row fade-in">
                    <div class="col-md-12">
                        <div class="info-card">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3><i class="fas fa-calendar-alt"></i> <span data-i18n="raid_calendar">Calendario de Raids</span></h3>
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select form-select-sm" id="calendarViewSelector" onchange="changeCalendarView()" style="width: 200px;">
                                        <option value="option1"><span data-i18n="week_view">Vista Semanal</span></option>
                                        <option value="option2"><span data-i18n="card_view">Vista Tarjetas</span></option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-light" onclick="loadPreviousWeek()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="currentWeekDisplay" class="mx-3"></span>
                                    <button class="btn btn-sm btn-outline-light" onclick="loadNextWeek()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- DKP Progress Bar -->
                            <div class="dkp-progress-container mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span style="font-size: 1.1rem; color: var(--midnight-glow);">
                                        <i class="fas fa-trophy"></i> <span data-i18n="this_week">Esta semana</span>
                                    </span>
                                    <span style="font-size: 1.3rem; font-weight: bold; color: var(--midnight-bright-purple);" id="weeklyDKPEarned">
                                        0 DKP <span data-i18n="earned">ganados</span>
                                    </span>
                                </div>
                                <div class="progress" style="height: 25px; background: rgba(138, 92, 246, 0.2);">
                                    <div class="progress-bar" id="dkpProgressBar" role="progressbar" style="background: linear-gradient(90deg, var(--midnight-bright-purple), var(--midnight-glow)); font-weight: bold;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="3">
                                        <span id="progressText">0/3</span>
                                    </div>
                                </div>
                            </div>

                            <!-- OPCI칍N 1: Vista Semanal (Week View) -->
                            <div id="calendarOption1" class="calendar-view">
                                <div class="week-view-container">
                                    <div class="week-days-grid" id="weekDaysGrid1">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- OPCI칍N 2: Vista Tarjetas (Card View) -->
                            <div id="calendarOption2" class="calendar-view" style="display: none;">
                                <div class="card-view-container">
                                    <div class="raid-cards-grid" id="raidCardsGrid2">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA칌A 6: ADMIN (Solo para admin/officer) -->
            <div class="tab-pane fade" id="admin" role="tabpanel">
                <div class="row fade-in">
                    <div class="col-md-12">
                        <div class="info-card">
                            <h3><i class="fas fa-crown"></i> <span data-i18n="admin_panel">Panel de Administraci칩n</span></h3>

                            <!-- Ajuste Masivo -->
                            <div class="mb-4">
                                <h5><i class="fas fa-users-cog"></i> <span data-i18n="bulk_adjustment">Ajuste Masivo de DKP (Todos los miembros)</span></h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <input type="number" id="bulkAmount" class="form-control mb-2" data-i18n-placeholder="amount">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" id="bulkReason" class="form-control mb-2" data-i18n-placeholder="reason">
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-success w-100" onclick="bulkAdjustDKP()">
                                            <i class="fas fa-users"></i> <span data-i18n="apply_to_all">Aplicar a Todos</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Warcraft Logs -->
                            <div class="mb-4">
                                <h5><i class="fas fa-scroll"></i> <span data-i18n="wcl_integration">Integraci칩n Warcraft Logs</span></h5>
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="text" id="warcraftLogsURL" class="form-control mb-2" data-i18n-placeholder="wcl_url">
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-warning w-100" onclick="previewWarcraftLogs()">
                                            <i class="fas fa-eye"></i> <span data-i18n="preview">Vista Previa</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="warcraftLogsPreview" class="mt-3"></div>
                            </div>

                            <!-- Raid Attendance Management -->
                            <div class="mb-4">
                                <h5><i class="fas fa-clipboard-check"></i> <span data-i18n="raid_attendance">Asistencia de Raids</span></h5>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <button class="btn btn-sm btn-outline-light" onclick="loadAdminPreviousWeek()">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span id="adminWeekDisplay" class="mx-3"></span>
                                        <button class="btn btn-sm btn-outline-light" onclick="loadAdminNextWeek()">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div>
                                        <select class="form-select form-select-sm" id="attendanceFilter" onchange="filterAttendance()">
                                            <option value="all"><span data-i18n="all_members">Todos</span></option>
                                            <option value="confirmed"><span data-i18n="only_confirmed">Solo Confirmados</span></option>
                                            <option value="declined"><span data-i18n="only_declined">Solo Rechazados</span></option>
                                            <option value="no_response"><span data-i18n="no_response">Sin Respuesta</span></option>
                                        </select>
                                    </div>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table class="attendance-table" id="attendanceTable">
                                        <thead>
                                            <tr>
                                                <th><span data-i18n="member">Miembro</span></th>
                                                <th><span data-i18n="class">Clase</span></th>
                                                <th><span data-i18n="role">Rol</span></th>
                                                <th style="text-align: center;">Lun</th>
                                                <th style="text-align: center;">Mar</th>
                                                <th style="text-align: center;">Mi칠</th>
                                                <th><span data-i18n="notes">Notas</span></th>
                                                <th style="text-align: center;"><span data-i18n="dkp_earned">DKP</span></th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceTableBody">
                                            <!-- Will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ======================================
        // WOW CLASSES DATA
        // ======================================
        const WOW_CLASSES = {
            'Death Knight': {
                icon: 'classicon_deathknight',
                specs: {
                    'Blood': { role: 'Tank', icon: 'spell_deathknight_bloodpresence' },
                    'Frost': { role: 'DPS', icon: 'spell_deathknight_frostpresence' },
                    'Unholy': { role: 'DPS', icon: 'spell_deathknight_unholypresence' }
                }
            },
            'Demon Hunter': {
                icon: 'classicon_demonhunter',
                specs: {
                    'Havoc': { role: 'DPS', icon: 'ability_demonhunter_specdps' },
                    'Vengeance': { role: 'Tank', icon: 'ability_demonhunter_spectank' }
                }
            },
            'Druid': {
                icon: 'classicon_druid',
                specs: {
                    'Balance': { role: 'DPS', icon: 'spell_nature_starfall' },
                    'Feral': { role: 'DPS', icon: 'ability_druid_catform' },
                    'Guardian': { role: 'Tank', icon: 'ability_racial_bearform' },
                    'Restoration': { role: 'Healer', icon: 'spell_nature_healingtouch' }
                }
            },
            'Evoker': {
                icon: 'classicon_evoker',
                specs: {
                    'Devastation': { role: 'DPS', icon: 'classicon_evoker' },
                    'Preservation': { role: 'Healer', icon: 'classicon_evoker' },
                    'Augmentation': { role: 'DPS', icon: 'classicon_evoker' }
                }
            },
            'Hunter': {
                icon: 'classicon_hunter',
                specs: {
                    'Beast Mastery': { role: 'DPS', icon: 'ability_hunter_bestialdiscipline' },
                    'Marksmanship': { role: 'DPS', icon: 'ability_hunter_focusedaim' },
                    'Survival': { role: 'DPS', icon: 'ability_hunter_camouflage' }
                }
            },
            'Mage': {
                icon: 'classicon_mage',
                specs: {
                    'Arcane': { role: 'DPS', icon: 'spell_holy_magicalsentry' },
                    'Fire': { role: 'DPS', icon: 'spell_fire_firebolt02' },
                    'Frost': { role: 'DPS', icon: 'spell_frost_frostbolt02' }
                }
            },
            'Monk': {
                icon: 'classicon_monk',
                specs: {
                    'Brewmaster': { role: 'Tank', icon: 'spell_monk_brewmaster_spec' },
                    'Mistweaver': { role: 'Healer', icon: 'spell_monk_mistweaver_spec' },
                    'Windwalker': { role: 'DPS', icon: 'spell_monk_windwalker_spec' }
                }
            },
            'Paladin': {
                icon: 'classicon_paladin',
                specs: {
                    'Holy': { role: 'Healer', icon: 'spell_holy_holybolt' },
                    'Protection': { role: 'Tank', icon: 'ability_paladin_shieldofthetemplar' },
                    'Retribution': { role: 'DPS', icon: 'spell_holy_auraoflight' }
                }
            },
            'Priest': {
                icon: 'classicon_priest',
                specs: {
                    'Discipline': { role: 'Healer', icon: 'spell_holy_powerwordshield' },
                    'Holy': { role: 'Healer', icon: 'spell_holy_guardianspirit' },
                    'Shadow': { role: 'DPS', icon: 'spell_shadow_shadowwordpain' }
                }
            },
            'Rogue': {
                icon: 'classicon_rogue',
                specs: {
                    'Assassination': { role: 'DPS', icon: 'ability_rogue_deadlybrew' },
                    'Outlaw': { role: 'DPS', icon: 'ability_rogue_waylay' },
                    'Subtlety': { role: 'DPS', icon: 'ability_stealth' }
                }
            },
            'Shaman': {
                icon: 'classicon_shaman',
                specs: {
                    'Elemental': { role: 'DPS', icon: 'spell_nature_lightning' },
                    'Enhancement': { role: 'DPS', icon: 'spell_shaman_improvedstormstrike' },
                    'Restoration': { role: 'Healer', icon: 'spell_nature_magicimmunity' }
                }
            },
            'Warlock': {
                icon: 'classicon_warlock',
                specs: {
                    'Affliction': { role: 'DPS', icon: 'spell_shadow_deathcoil' },
                    'Demonology': { role: 'DPS', icon: 'spell_shadow_metamorphosis' },
                    'Destruction': { role: 'DPS', icon: 'spell_shadow_rainoffire' }
                }
            },
            'Warrior': {
                icon: 'classicon_warrior',
                specs: {
                    'Arms': { role: 'DPS', icon: 'ability_warrior_savageblow' },
                    'Fury': { role: 'DPS', icon: 'ability_warrior_innerrage' },
                    'Protection': { role: 'Tank', icon: 'ability_warrior_defensivestance' }
                }
            }
        };

        const ROLE_ICONS = {
            'Tank': 'inv_shield_06',
            'Healer': 'spell_holy_flashheal',
            'DPS': 'inv_sword_27'
        };

        // ======================================
        // CONFIGURACI칍N
        // ======================================
        const API_URL = 'http://localhost:3000/api';
        const SOCKET_URL = 'http://localhost:3000';

        let token = localStorage.getItem('token');
        let socket = null;
        let currentUser = null;
        
        // ======================================
        // VERIFICAR AUTENTICACI칍N
        // ======================================
        if (!token) {
            window.location.href = 'login.html';
        }
        
        // ======================================
        // FUNCI칍N HELPER PARA FETCH
        // ======================================
        async function fetchWithAuth(url, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            
            options.headers['Authorization'] = `Bearer ${token}`;
            
            if (options.body && typeof options.body === 'object') {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            
            const response = await fetch(url, options);
            
            if (response.status === 401) {
                showAlert(t('session_expired', localStorage.getItem('language') || 'es'), null, 'warning');
                logout();
                return null;
            }
            
            return response;
        }

        // ======================================
        // CUSTOM MODAL SYSTEM
        // ======================================
        function showModal(config) {
            const lang = localStorage.getItem('language') || 'es';
            const {
                title,
                body,
                buttons = [],
                size = 'md', // sm, md, lg
                onClose = null
            } = config;

            const modalId = 'modal_' + Date.now();
            const sizeClass = size === 'lg' ? 'width: 800px;' : size === 'sm' ? 'width: 400px;' : 'width: 600px;';

            const buttonHtml = buttons.map((btn, index) => {
                const variant = btn.variant || 'primary';
                const classList = variant === 'danger' ? 'btn-danger' :
                                 variant === 'success' ? 'btn-success' :
                                 variant === 'secondary' ? 'btn-secondary' :
                                 'btn-primary';
                return `<button class="btn ${classList}" onclick="window.modalButtons['${modalId}_${index}']()" ${btn.disabled ? 'disabled' : ''}>
                    ${btn.icon ? `<i class="${btn.icon}"></i>` : ''} ${btn.text}
                </button>`;
            }).join('');

            const html = `
                <div class="custom-modal-overlay active" id="${modalId}">
                    <div class="custom-modal" style="${sizeClass}">
                        <div class="custom-modal-header">
                            <h3 class="custom-modal-title">${title}</h3>
                            <button class="custom-modal-close" onclick="closeModal('${modalId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="custom-modal-body">
                            ${body}
                        </div>
                        ${buttons.length > 0 ? `
                        <div class="custom-modal-footer">
                            ${buttonHtml}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('modalContainer').insertAdjacentHTML('beforeend', html);

            // Store button callbacks
            if (!window.modalButtons) window.modalButtons = {};
            buttons.forEach((btn, index) => {
                window.modalButtons[`${modalId}_${index}`] = () => {
                    if (btn.onClick) btn.onClick();
                    if (!btn.keepOpen) closeModal(modalId);
                };
            });

            // Handle close callback
            if (onClose) {
                window[`${modalId}_onClose`] = onClose;
            }

            return modalId;
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (window[`${modalId}_onClose`]) {
                    window[`${modalId}_onClose`]();
                    delete window[`${modalId}_onClose`];
                }
                modal.remove();
            }
        }

        function showAlert(message, title = null, variant = 'info') {
            const lang = localStorage.getItem('language') || 'es';
            const icon = variant === 'error' ? 'fa-exclamation-circle' :
                        variant === 'success' ? 'fa-check-circle' :
                        variant === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle';

            const color = variant === 'error' ? '#ef4444' :
                         variant === 'success' ? '#22c55e' :
                         variant === 'warning' ? '#fbbf24' :
                         '#3b82f6';

            showModal({
                title: title || t('error', lang),
                body: `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas ${icon}" style="font-size: 3rem; color: ${color}; margin-bottom: 15px;"></i>
                        <p style="font-size: 1.1rem;">${message}</p>
                    </div>
                `,
                buttons: [
                    { text: 'OK', variant: 'primary', onClick: () => {} }
                ]
            });
        }

        function showConfirm(message, title, onConfirm) {
            const lang = localStorage.getItem('language') || 'es';
            showModal({
                title: title || t('confirm', lang),
                body: `
                    <div style="padding: 20px;">
                        <p style="font-size: 1.1rem;">${message}</p>
                    </div>
                `,
                buttons: [
                    { text: lang === 'es' ? 'Cancelar' : 'Cancel', variant: 'secondary', onClick: () => {} },
                    { text: lang === 'es' ? 'Confirmar' : 'Confirm', variant: 'primary', onClick: onConfirm }
                ]
            });
        }

        function showPrompt(message, defaultValue = '', onConfirm, title = null, inputType = 'text') {
            const lang = localStorage.getItem('language') || 'es';
            const inputId = 'prompt_input_' + Date.now();

            showModal({
                title: title || (lang === 'es' ? 'Entrada' : 'Input'),
                body: `
                    <div style="padding: 20px;">
                        <p style="font-size: 1rem; margin-bottom: 15px;">${message}</p>
                        <input type="${inputType}" id="${inputId}" class="form-control" value="${defaultValue}"
                               style="width: 100%;" onkeypress="if(event.key === 'Enter') document.getElementById('${inputId}_confirm').click()">
                    </div>
                `,
                buttons: [
                    { text: lang === 'es' ? 'Cancelar' : 'Cancel', variant: 'secondary', onClick: () => {} },
                    {
                        text: 'OK',
                        variant: 'primary',
                        onClick: () => {
                            const value = document.getElementById(inputId).value;
                            if (onConfirm) onConfirm(value);
                        }
                    }
                ]
            });

            // Focus the input after modal appears
            setTimeout(() => {
                const input = document.getElementById(inputId);
                if (input) input.focus();
            }, 100);
        }

        // ======================================
        // MULTI-LANGUAGE SUPPORT
        // ======================================
        function changeLanguage(lang) {
            localStorage.setItem('language', lang);

            // Update dropdown display
            const flagEl = document.getElementById('currentFlag');
            const langNameEl = document.getElementById('currentLangName');
            if (lang === 'es') {
                flagEl.textContent = '游쀯릖';
                langNameEl.textContent = 'Espa침ol';
            } else {
                flagEl.textContent = '游섫릖';
                langNameEl.textContent = 'English';
            }

            updateLanguage();
        }

        function updateLanguage() {
            const lang = localStorage.getItem('language') || 'es';

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key, lang);
            });

            // Update all placeholders with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key, lang);
            });

            // Update navbar
            const navbarBrand = document.querySelector('.navbar-brand');
            navbarBrand.innerHTML = `<i class="fas fa-moon"></i> ${t('guild_name', lang)}<br><small>${t('midnight_edition', lang)}</small>`;

            // Connection status removed - no longer needed

            // Reload data to refresh all labels
            if (currentUser) {
                loadUserData();
                loadMembers();
                loadActiveAuction();
                loadAuctionsHistory();
            }
        }

        function initLanguage() {
            const lang = localStorage.getItem('language') || 'es';

            // Update dropdown display
            const flagEl = document.getElementById('currentFlag');
            const langNameEl = document.getElementById('currentLangName');
            if (lang === 'es') {
                flagEl.textContent = '游쀯릖';
                langNameEl.textContent = 'Espa침ol';
            } else {
                flagEl.textContent = '游섫릖';
                langNameEl.textContent = 'English';
            }

            updateLanguage();
        }

        // ======================================
        // CARGAR DATOS DEL USUARIO
        // ======================================
        async function loadUserData() {
            try {
                // Obtener info del usuario
                const responseUser = await fetchWithAuth(`${API_URL}/auth/me`);
                if (!responseUser) return;
                
                currentUser = await responseUser.json();
                
                // Actualizar username en navbar
                document.getElementById('username').textContent = currentUser.characterName || currentUser.username;

                // Obtener DKP e historial
                const responseDKP = await fetchWithAuth(`${API_URL}/dkp/history/${currentUser.id}`);
                if (!responseDKP) return;

                const dkpData = await responseDKP.json();

                // Mostrar info del personaje
                mostrarInfoPersonaje(currentUser, dkpData);

                // Mostrar transacciones
                mostrarTransacciones(dkpData.transactions || []);

                // Cargar subasta activa
                await loadActiveAuction();

                // Verificar acceso admin
                checkAdminAccess();

            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                mostrarError('No se pudieron cargar los datos. Verifica que el servidor est칠 corriendo.');
            }
        }

        // ======================================
        // MOSTRAR INFO DEL PERSONAJE
        // ======================================
        function mostrarInfoPersonaje(user, dkpData) {
            const lang = localStorage.getItem('language') || 'es';
            // Info del personaje
            const claseCSS = `class-${(user.characterClass || '').toLowerCase().replace(' ', '-')}`;

            document.getElementById('characterInfo').innerHTML = `
                <p><strong>${t('name', lang)}:</strong> <span class="${claseCSS}">${user.characterName || '-'}</span></p>
                <p><strong>${t('class', lang)}:</strong> <span class="${claseCSS}">${user.characterClass || '-'}</span></p>
                <p><strong>${t('role', lang)}:</strong> <span>${user.raidRole || '-'}</span></p>
                <p><strong>${t('rank', lang)}:</strong> <span class="badge bg-primary">${t('role_' + (user.role || 'raider'), lang)}</span></p>
            `;

            // DKP actual
            document.getElementById('currentDKP').textContent = dkpData.currentDkp || 0;

            // Estad칤sticas
            document.getElementById('statsInfo').innerHTML = `
                <p><strong>${t('total_gained', lang)}:</strong> <span class="amount-positive">${dkpData.lifetimeGained || 0} DKP</span></p>
                <p><strong>${t('total_spent', lang)}:</strong> <span class="amount-negative">${dkpData.lifetimeSpent || 0} DKP</span></p>
                <p><strong>${t('last_decay', lang)}:</strong> <span>${dkpData.lastDecay ? new Date(dkpData.lastDecay).toLocaleDateString() : t('never', lang)}</span></p>
            `;
        }
        
        // ======================================
        // MOSTRAR TRANSACCIONES
        // ======================================
        function mostrarTransacciones(transactions) {
            const lang = localStorage.getItem('language') || 'es';
            const contenedor = document.getElementById('transactionsList');

            if (!transactions || transactions.length === 0) {
                contenedor.innerHTML = `<p class="text-center" style="color: #8888aa;">${t('no_transactions', lang)}</p>`;
                return;
            }
            
            let html = '';
            
            transactions.forEach(trans => {
                const esPositivo = trans.amount > 0;
                const claseColor = esPositivo ? 'amount-positive' : 'amount-negative';
                const signo = esPositivo ? '+' : '';
                const icono = esPositivo ? 'fa-arrow-up' : 'fa-arrow-down';
                
                const fecha = new Date(trans.created_at);
                const fechaTexto = fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="transaction-row">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <i class="fas fa-coins" style="color: var(--midnight-glow); margin-right: 10px;"></i>
                                <strong>${trans.reason}</strong>
                                <br>
                                <small style="color: #a5b4fc; margin-left: 28px;">
                                    <i class="far fa-calendar-alt"></i> ${fechaTexto}
                                </small>
                            </div>
                            <div style="min-width: 120px; text-align: right;">
                                <span class="${claseColor}" style="font-size: 18px;">
                                    <i class="fas ${icono}"></i> ${signo}${trans.amount} DKP
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        // ======================================
        // CARGAR SUBASTAS ACTIVAS
        // ======================================
        async function loadActiveAuctions() {
            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/auctions/active`);
                if (!response) return;

                const data = await response.json();
                const auctions = data.auctions || [];

                if (auctions.length === 0) {
                    document.getElementById('auctionContent').innerHTML = `<p class="text-center" style="color: #8888aa;">${t('no_active_auction', lang)}</p>`;
                    return;
                }

                // Render multiple auctions in accordion
                let html = '';
                auctions.forEach((auction, index) => {
                    const highestBid = auction.currentBid || 0;
                    const minBid = Math.max(highestBid + 1, 1);

                    // Get translated item name
                    const itemName = lang === 'en' && auction.item_name_en ? auction.item_name_en : auction.item_name;
                    const itemNameEscaped = itemName.replace(/'/g, "\\'");

                    html += `
                        <div class="auction-accordion">
                            <div class="auction-header ${index === 0 ? 'active' : ''}" onclick="toggleAuction(${auction.id})">
                                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                    <img src="${auction.itemImage}" style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--midnight-bright-purple);" alt="${itemName}">
                                    <div style="flex: 1;">
                                        <div class="item-rarity-${auction.itemRarity}" style="font-size: 1.2rem; font-weight: bold;">${itemName}</div>
                                        <div style="font-size: 0.9rem; color: var(--midnight-silver); opacity: 0.8;">
                                            ${t('current_bid', lang)}: <strong>${highestBid} DKP</strong> | ${t('total_bids', lang)}: <strong>${auction.bidsCount || 0}</strong>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); showBidModal(${auction.id}, ${highestBid}, '${itemNameEscaped}')">
                                    <i class="fas fa-hand-holding-usd"></i> ${t('place_bid', lang)}
                                </button>
                            </div>
                            <div class="auction-body ${index === 0 ? 'active' : ''}" id="auction_body_${auction.id}">
                                <h5 style="color: var(--midnight-glow); margin-bottom: 15px;">
                                    <i class="fas fa-list"></i> ${t('total_bids', lang)} (${auction.bidsCount || 0})
                                </h5>
                                ${renderAuctionBids(auction.bids || [])}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('auctionContent').innerHTML = html;

            } catch (error) {
                console.error('Error loading auctions:', error);
                document.getElementById('auctionContent').innerHTML = `<p class="text-center" style="color: #8888aa;">${t('error', lang)}</p>`;
            }
        }

        function renderAuctionBids(bids) {
            const lang = localStorage.getItem('language') || 'es';

            if (bids.length === 0) {
                return `<p style="text-align: center; color: var(--midnight-silver); opacity: 0.7;">${lang === 'es' ? 'No hay pujas a칰n' : 'No bids yet'}</p>`;
            }

            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            bids.forEach((bid, index) => {
                const classColor = getClassColor(bid.characterClass);
                html += `
                    <div style="padding: 10px; margin-bottom: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: ${classColor}; font-weight: bold;">${bid.characterName}</span>
                            ${index === 0 ? '<i class="fas fa-crown" style="color: #fbbf24; margin-left: 5px;"></i>' : ''}
                        </div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--midnight-glow);">${bid.amount} DKP</div>
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }

        function toggleAuction(auctionId) {
            const header = event.currentTarget;
            const body = document.getElementById(`auction_body_${auctionId}`);

            // Toggle this auction
            header.classList.toggle('active');
            body.classList.toggle('active');
        }

        // ======================================
        // PUJAR EN SUBASTA
        // ======================================
        async function showBidModal(auctionId, currentBid, itemName) {
            const lang = localStorage.getItem('language') || 'es';
            const minBid = Math.max(currentBid + 1, 1);

            const modalBody = `
                <div style="padding: 20px; text-align: center;">
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">
                        ${lang === 'es' ? 'Pujando por:' : 'Bidding on:'} <strong class="item-rarity-epic">${itemName}</strong>
                    </p>
                    <div class="form-group-modal">
                        <label>${lang === 'es' ? 'Cantidad de DKP' : 'DKP Amount'}</label>
                        <input type="number" id="bidAmount" class="form-control" min="${minBid}" value="${minBid}" placeholder="${minBid}">
                        <small style="color: var(--midnight-silver); opacity: 0.8;">
                            ${lang === 'es' ? 'Puja actual:' : 'Current bid:'} <strong>${currentBid} DKP</strong> |
                            ${lang === 'es' ? 'M칤nimo:' : 'Minimum:'} <strong>${minBid} DKP</strong>
                        </small>
                    </div>
                </div>
            `;

            showModal({
                title: lang === 'es' ? 'Realizar Puja' : 'Place Bid',
                body: modalBody,
                buttons: [
                    { text: lang === 'es' ? 'Cancelar' : 'Cancel', variant: 'secondary' },
                    {
                        text: lang === 'es' ? 'Pujar' : 'Bid',
                        variant: 'primary',
                        icon: 'fas fa-gavel',
                        onClick: async () => {
                            const amount = parseInt(document.getElementById('bidAmount').value);

                            if (isNaN(amount) || amount < minBid) {
                                showAlert(
                                    lang === 'es' ? `La puja debe ser al menos ${minBid} DKP` : `Bid must be at least ${minBid} DKP`,
                                    null,
                                    'warning'
                                );
                                return;
                            }

                            try {
                                const response = await fetchWithAuth(`${API_URL}/auctions/${auctionId}/bid`, {
                                    method: 'POST',
                                    body: { amount }
                                });

                                if (response && response.ok) {
                                    showAlert(
                                        lang === 'es' ? `춰Puja realizada! Has pujado ${amount} DKP` : `Bid placed! You bid ${amount} DKP`,
                                        lang === 'es' ? '칄xito' : 'Success',
                                        'success'
                                    );
                                    await loadActiveAuctions();
                                } else {
                                    const error = await response.json();
                                    showAlert(error.error || (lang === 'es' ? 'No se pudo realizar la puja' : 'Could not place bid'), null, 'error');
                                }
                            } catch (error) {
                                console.error('Error placing bid:', error);
                                showAlert(lang === 'es' ? 'Error de conexi칩n' : 'Connection error', null, 'error');
                            }
                        }
                    }
                ]
            });
        }

        // Alias for backwards compatibility
        const loadActiveAuction = loadActiveAuctions;
        
        // ======================================
        // ANIMAR DKP
        // ======================================
        function animateDKP() {
            const elemento = document.getElementById('currentDKP');
            const valorActual = parseInt(elemento.textContent) || 0;
            
            let contador = 0;
            const intervalo = setInterval(() => {
                contador += Math.ceil(valorActual / 20);
                if (contador >= valorActual) {
                    contador = valorActual;
                    clearInterval(intervalo);
                }
                elemento.textContent = contador;
            }, 50);
            
            elemento.style.transform = 'scale(1.3)';
            setTimeout(() => {
                elemento.style.transform = 'scale(1)';
            }, 500);
        }
        
        // ======================================
        // SOCKET.IO
        // ======================================
        function connectSocket() {
            socket = io(SOCKET_URL, {
                auth: { token: token }
            });
            
            socket.on('connect', () => {
                console.log('九 Conectado a Socket.IO');
            });

            socket.on('disconnect', () => {
                console.log('仇 Desconectado de Socket.IO');
            });
            
            socket.on('dkp_updated', (data) => {
                console.log('游눯 DKP actualizado:', data);
                if (currentUser && data.userId === currentUser.id) {
                    loadUserData();
                }
            });
            
            socket.on('bid_placed', (bidData) => {
                console.log('游눳 Nueva puja:', bidData);
                loadActiveAuction();
            });
            
            socket.on('auction_started', (auction) => {
                console.log('游꿀 Nueva subasta:', auction);
                const lang = localStorage.getItem('language') || 'es';
                showAlert(
                    `${lang === 'es' ? '춰Nueva subasta!' : 'New auction!'} ${auction.item_name}`,
                    lang === 'es' ? '游꿀 Nueva Subasta' : '游꿀 New Auction',
                    'success'
                );
                loadActiveAuction();
            });
            
            socket.on('auction_ended', (result) => {
                console.log('游끥 Subasta finalizada:', result);
                loadActiveAuction();
            });
        }
        
        // ======================================
        // LOGOUT
        // ======================================
        function showMyCharacterTab() {
            const personajeTab = new bootstrap.Tab(document.getElementById('personaje-tab'));
            personajeTab.show();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');

            if (socket) {
                socket.disconnect();
            }
            
            window.location.href = 'login.html';
        }
        
        // ======================================
        // MOSTRAR ERROR
        // ======================================
        function mostrarError(mensaje) {
            document.getElementById('characterInfo').innerHTML = `<p class="text-danger">${mensaje}</p>`;
            document.getElementById('statsInfo').innerHTML = `<p class="text-danger">${mensaje}</p>`;
            document.getElementById('transactionsList').innerHTML = `<p class="text-danger">${mensaje}</p>`;
            document.getElementById('auctionContent').innerHTML = `<p class="text-danger">${mensaje}</p>`;
        }
        
        // ======================================
        // CARGAR LISTA DE MIEMBROS
        // ======================================
        async function loadMembers() {
            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/members`);
                if (!response) return;

                const members = await response.json();
                const contenedor = document.getElementById('membersList');

                if (!members || members.length === 0) {
                    contenedor.innerHTML = `<p class="text-center" style="color: #8888aa;">${t('no_members', lang)}</p>`;
                    return;
                }

                const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'officer');

                let html = '<div class="table-responsive"><table class="table table-dark table-striped">';
                html += `<thead><tr><th>${t('character', lang)}</th><th>${t('spec', lang)}</th><th>${t('role', lang)}</th><th>DKP</th>`;
                if (isAdmin) {
                    html += `<th>${t('actions', lang)}</th>`;
                }
                html += '</tr></thead><tbody>';

                members.forEach(m => {
                    const classColor = getClassColor(m.characterClass);
                    const classIcon = getClassIcon(m.characterClass);
                    const roleIcon = getRoleIcon(m.raidRole || 'DPS');
                    html += `
                        <tr>
                            <td>
                                <img src="${classIcon}" alt="${m.characterClass}" style="width: 18px; height: 18px; margin-right: 5px; vertical-align: middle; border-radius: 3px;">
                                <strong style="color: ${classColor};">${m.characterName}</strong>
                            </td>
                            <td>${m.spec || '-'}</td>
                            <td>
                                <img src="${roleIcon}" alt="${m.raidRole}" style="width: 16px; height: 16px; margin-right: 3px; vertical-align: middle;">
                                ${m.raidRole || 'DPS'}
                            </td>
                            <td><strong>${m.currentDkp || 0}</strong> DKP</td>
                    `;

                    if (isAdmin) {
                        const resetPasswordTitle = lang === 'es' ? 'Resetear Contrase침a' : 'Reset Password';
                        html += `
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-success" onclick="quickAdjustDKP(${m.id}, '${m.characterName}', 1)" title="${t('add_dkp', lang)}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="quickAdjustDKP(${m.id}, '${m.characterName}', -1)" title="${t('subtract_dkp', lang)}">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="customAdjustDKP(${m.id}, '${m.characterName}')" title="${t('custom_adjustment', lang)}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-warning" onclick="showResetPasswordModal(${m.id}, '${m.characterName}')" title="${resetPasswordTitle}">
                                        <i class="fas fa-key"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                    }

                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                contenedor.innerHTML = html;
            } catch (error) {
                console.error('Error cargando miembros:', error);
            }
        }

        function getClassColor(className) {
            const colors = {
                'Warrior': '#C79C6E',
                'Paladin': '#F58CBA',
                'Hunter': '#ABD473',
                'Rogue': '#FFF569',
                'Priest': '#FFFFFF',
                'Shaman': '#0070DE',
                'Mage': '#40C7EB',
                'Warlock': '#8788EE',
                'Druid': '#FF7D0A',
                'Death Knight': '#C41F3B'
            };
            return colors[className] || '#FFFFFF';
        }

        function getClassIcon(className) {
            const classNames = {
                'Warrior': 'warrior',
                'Paladin': 'paladin',
                'Hunter': 'hunter',
                'Rogue': 'rogue',
                'Priest': 'priest',
                'Shaman': 'shaman',
                'Mage': 'mage',
                'Warlock': 'warlock',
                'Druid': 'druid',
                'Death Knight': 'deathknight'
            };
            const iconName = classNames[className] || 'warrior';
            return `https://wow.zamimg.com/images/wow/icons/small/classicon_${iconName}.jpg`;
        }

        function getRoleIcon(role) {
            const roleIcons = {
                'Tank': 'https://wow.zamimg.com/images/wow/icons/small/inv_shield_06.jpg',
                'Healer': 'https://wow.zamimg.com/images/wow/icons/small/spell_holy_flashheal.jpg',
                'DPS': 'https://wow.zamimg.com/images/wow/icons/small/inv_sword_27.jpg'
            };
            return roleIcons[role] || roleIcons['DPS'];
        }

        // ======================================
        // CARGAR HISTORIAL DE SUBASTAS
        // ======================================
        async function loadAuctionsHistory() {
            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/auctions/history`);
                if (!response) return;

                const subastas = await response.json();
                const contenedor = document.getElementById('auctionsHistoryList');

                if (!subastas || subastas.length === 0) {
                    contenedor.innerHTML = `<p class="text-center" style="color: #8888aa;">${t('no_auction_history', lang)}</p>`;
                    return;
                }

                let html = '';
                subastas.slice(0, 20).forEach(s => {
                    const winner = s.winner ? `<strong>${s.winner.characterName}</strong> ${lang === 'es' ? 'por' : 'for'} <strong>${s.winning_bid} DKP</strong>` : t('no_winner', lang);
                    const status = s.status === 'ended' ? t('completed', lang) : t('cancelled', lang);
                    const statusClass = s.status === 'ended' ? 'text-success' : 'text-warning';

                    html += `
                        <div class="transaction-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-gavel" style="color: var(--midnight-glow); margin-right: 10px;"></i>
                                    <strong>${s.item_name}</strong>
                                    <br>
                                    <small style="color: #a5b4fc; margin-left: 28px;">
                                        ${winner} | <span class="${statusClass}">${status}</span>
                                    </small>
                                </div>
                                <div style="text-align: right;">
                                    <small style="color: #8888aa;">${new Date(s.created_at).toLocaleDateString()}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                contenedor.innerHTML = html;
            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }

        // ======================================
        // FUNCIONES DE ADMIN
        // ======================================
        async function quickAdjustDKP(userId, characterName, amount) {
            const reason = amount > 0 ? 'Ajuste r치pido (+1)' : 'Ajuste r치pido (-1)';

            try {
                const response = await fetchWithAuth(`${API_URL}/dkp/adjust`, {
                    method: 'POST',
                    body: { userId: parseInt(userId), amount, reason }
                });

                if (response.ok) {
                    loadMembers();
                    // Si el ajuste es al usuario actual, recargar su info
                    if (currentUser && parseInt(userId) === currentUser.id) {
                        loadUserData();
                    }
                } else {
                    showAlert('Error al ajustar DKP', 'Error', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al ajustar DKP', 'Error', 'error');
            }
        }

        async function customAdjustDKP(userId, characterName) {
            const lang = localStorage.getItem('language') || 'es';
            const promptMsg = lang === 'es' ? `Ajustar DKP para ${characterName}<br>Ingresa cantidad (+/-):` : `Adjust DKP for ${characterName}<br>Enter amount (+/-):`;
            const defaultReason = lang === 'es' ? 'Ajuste manual' : 'Manual adjustment';

            // First prompt for amount
            showPrompt(promptMsg, '0', async (amount) => {
                if (!amount) return; // Cancelled

                const amountNum = parseInt(amount);
                if (isNaN(amountNum) || amountNum === 0) {
                    showAlert(lang === 'es' ? 'Cantidad inv치lida' : 'Invalid amount', lang === 'es' ? 'Error' : 'Error', 'error');
                    return;
                }

                // Second prompt for reason
                const reasonPrompt = lang === 'es' ? 'Motivo del ajuste:' : 'Adjustment reason:';
                showPrompt(reasonPrompt, defaultReason, async (reason) => {
                    if (!reason) return; // Cancelled

                    try {
                const response = await fetchWithAuth(`${API_URL}/dkp/adjust`, {
                    method: 'POST',
                    body: { userId: parseInt(userId), amount: amountNum, reason: reason || defaultReason }
                });

                if (response.ok) {
                    showAlert(t('dkp_adjusted_successfully', lang), t('success', lang), 'success');
                    loadMembers();
                    // Si el ajuste es al usuario actual, recargar su info
                    if (currentUser && parseInt(userId) === currentUser.id) {
                        loadUserData();
                    }
                    } else {
                        showAlert(t('error_adjusting_dkp', lang), t('error', lang), 'error');
                    }
                    } catch (error) {
                        console.error('Error:', error);
                        showAlert(t('error_adjusting_dkp', lang), t('error', lang), 'error');
                    }
                }, lang === 'es' ? 'Motivo del Ajuste' : 'Adjustment Reason');
            }, lang === 'es' ? 'Ajustar DKP' : 'Adjust DKP');
        }

        async function bulkAdjustDKP() {
            const lang = localStorage.getItem('language') || 'es';
            const amount = parseInt(document.getElementById('bulkAmount').value);
            const reason = document.getElementById('bulkReason').value;

            if (!amount || !reason) {
                showAlert(t('please_complete_fields', lang), t('error', lang), 'warning');
                return;
            }

            const confirmMsg = lang === 'es' ? `쮼st치s seguro de aplicar ${amount} DKP a TODOS los miembros?` : `Are you sure you want to apply ${amount} DKP to ALL members?`;

            showConfirm(confirmMsg, t('confirm', lang), async () => {
                try {
                    // Obtener todos los IDs
                const membersResp = await fetchWithAuth(`${API_URL}/members`);
                const members = await membersResp.json();
                const userIds = members.map(m => m.id);

                const response = await fetchWithAuth(`${API_URL}/dkp/bulk-adjust`, {
                    method: 'POST',
                    body: { userIds, amount, reason }
                });

                if (response.ok) {
                    showAlert(t('dkp_adjusted_for_all', lang), t('success', lang), 'success');
                    loadMembers();
                    loadUserData(); // Recargar datos del usuario actual
                    document.getElementById('bulkAmount').value = '';
                    document.getElementById('bulkReason').value = '';
                } else {
                    showAlert(t('error_adjusting_dkp', lang), t('error', lang), 'error');
                }
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('Error al ajustar DKP', 'Error', 'error');
                }
            });
        }

        async function previewWarcraftLogs() {
            const lang = localStorage.getItem('language') || 'es';
            const url = document.getElementById('warcraftLogsURL').value;

            if (!url) {
                showAlert(t('please_complete_fields', lang), t('error', lang), 'warning');
                return;
            }

            const preview = document.getElementById('warcraftLogsPreview');
            preview.innerHTML = `<p class="text-info">${t('processing', lang)}</p>`;

            try {
                const response = await fetchWithAuth(`${API_URL}/warcraftlogs/preview`, {
                    method: 'POST',
                    body: { url }
                });

                if (!response.ok) {
                    const error = await response.json();
                    preview.innerHTML = `<p class="text-danger">${t('error', lang)}: ${error.error || t('error_processing_wcl', lang)}</p>`;
                    return;
                }

                const data = await response.json();

                // Mostrar info del reporte
                let html = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-scroll"></i> ${data.report.title}</h6>
                        <p class="mb-0">
                            <strong>${t('bosses', lang)}:</strong> ${data.report.bossesKilled}/${data.report.totalBosses} (${data.report.totalAttempts} ${lang === 'es' ? 'intentos' : 'attempts'}) |
                            <strong>${t('participants', lang)}:</strong> ${data.report.participantCount} |
                            <strong>${t('dkp_per_player', lang)}:</strong> ${data.dkp_calculation.dkp_per_player}
                        </p>
                    </div>
                `;

                // Mostrar participantes matched
                const matched = data.participants.filter(p => p.matched);
                const notMatched = data.participants.filter(p => !p.matched);

                if (matched.length > 0) {
                    html += `<h6>${t('players_to_receive', lang)}:</h6>`;
                    html += `<table class="table table-sm table-dark table-striped"><thead><tr><th>${t('character', lang)}</th><th>${t('current_dkp_label', lang)}</th><th>${t('dkp_to_grant', lang)}</th></tr></thead><tbody>`;

                    matched.forEach(p => {
                        html += `<tr>
                            <td>${p.character_name}</td>
                            <td>${p.current_dkp || 0}</td>
                            <td class="text-success">+${p.dkp_to_assign} DKP</td>
                        </tr>`;
                    });

                    html += '</tbody></table>';
                }

                // Mostrar no encontrados si hay
                if (notMatched.length > 0) {
                    html += `<div class="alert alert-warning mt-3">
                        <strong>丘멆잺 ${notMatched.length} ${t('not_found_in_db', lang)}:</strong>
                        <ul class="mb-0 mt-2">`;
                    notMatched.forEach(p => {
                        html += `<li>${p.wcl_name} (${p.wcl_server}) - ${p.wcl_class}</li>`;
                    });
                    html += '</ul></div>';
                }

                // Bot칩n de confirmar
                if (data.can_proceed && matched.length > 0) {
                    html += `<button class="btn btn-success mt-3" onclick="confirmWarcraftLogs('${data.report.code}')">
                        <i class="fas fa-check"></i> ${t('confirm_apply_to', lang)} ${matched.length} ${t('players', lang)}
                    </button>`;
                } else {
                    html += `<div class="alert alert-danger mt-3">${t('cannot_proceed', lang)}</div>`;
                }

                preview.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                preview.innerHTML = `<p class="text-danger">${t('error_processing_wcl', lang)}: ${error.message || t('error', lang)}</p>`;
            }
        }

        async function confirmWarcraftLogs(reportId) {
            const lang = localStorage.getItem('language') || 'es';

            showConfirm(
                lang === 'es' ? '쮺onfirmar aplicaci칩n de DKP desde Warcraft Logs?' : 'Confirm DKP application from Warcraft Logs?',
                t('confirm', lang),
                async () => {
                    try {
                const response = await fetchWithAuth(`${API_URL}/warcraftlogs/confirm`, {
                    method: 'POST',
                    body: { reportId }
                });

                if (response.ok) {
                    showAlert(t('dkp_applied_from_wcl', lang), t('success', lang), 'success');
                    document.getElementById('warcraftLogsURL').value = '';
                    document.getElementById('warcraftLogsPreview').innerHTML = '';
                    loadMembers();
                    loadUserData(); // Recargar datos del usuario actual
                } else {
                    showAlert(t('error_adjusting_dkp', lang), t('error', lang), 'error');
                }
                    } catch (error) {
                        console.error('Error:', error);
                        const lang = localStorage.getItem('language') || 'es';
                        showAlert('Error al aplicar DKP', t('error', lang), 'error');
                    }
                }
            );
        }


        // Mostrar pesta침a de admin si es admin/officer
        function checkAdminAccess() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'officer')) {
                document.getElementById('admin-tab-item').style.display = 'block';
                document.getElementById('btnAddMember').style.display = 'inline-block';
                document.getElementById('btnCreateAuction').style.display = 'inline-block';
                loadMembers(); // Cargar miembros para el dropdown
            }
        }

        // Mostrar modal para a침adir miembro
        function onClassChange() {
            const classSelect = document.getElementById('memberClass');
            const specSelect = document.getElementById('memberSpec');
            const selectedClass = classSelect.value;

            // Clear current specs
            specSelect.innerHTML = '<option value="">-- Selecciona especializaci칩n --</option>';

            if (selectedClass && WOW_CLASSES[selectedClass]) {
                const specs = WOW_CLASSES[selectedClass].specs;
                Object.entries(specs).forEach(([specName, specData]) => {
                    const option = document.createElement('option');
                    option.value = specName;
                    option.setAttribute('data-role', specData.role);
                    option.textContent = specName;
                    specSelect.appendChild(option);
                });
                specSelect.disabled = false;
            } else {
                specSelect.disabled = true;
            }

            // Reset role
            document.getElementById('memberRole').value = '';
        }

        function onSpecChange() {
            const specSelect = document.getElementById('memberSpec');
            const roleSelect = document.getElementById('memberRole');
            const selectedOption = specSelect.options[specSelect.selectedIndex];

            if (selectedOption && selectedOption.hasAttribute('data-role')) {
                const role = selectedOption.getAttribute('data-role');
                roleSelect.value = role;
            }
        }

        function generatePassword() {
            const characterName = document.getElementById('memberCharacterName').value;
            const passwordField = document.getElementById('memberPassword');

            if (characterName) {
                passwordField.value = `${characterName}_pewpew`;
            }
        }

        function showAddMemberModal() {
            const lang = localStorage.getItem('language') || 'es';

            // Build class options with icons
            let classOptions = '<option value="">-- Selecciona clase --</option>';
            Object.entries(WOW_CLASSES).forEach(([className, classData]) => {
                classOptions += `<option value="${className}">${className}</option>`;
            });

            // Build role options with icons
            const roleOptions = `
                <option value="">-- Auto (seg칰n spec) --</option>
                <option value="Tank">游띠勇 Tank</option>
                <option value="Healer">九 Healer</option>
                <option value="DPS">丘덢잺 DPS</option>
            `;

            const modalBody = `
                <div style="padding: 20px;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="color: var(--midnight-glow); font-weight: bold;">
                                <i class="fas fa-user"></i> ${lang === 'es' ? 'Nombre de Usuario' : 'Username'}
                            </label>
                            <input type="text" id="memberUsername" class="form-control" placeholder="${lang === 'es' ? 'Nombre de usuario' : 'Username'}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="color: var(--midnight-glow); font-weight: bold;">
                                <i class="fas fa-user-shield"></i> ${lang === 'es' ? 'Nombre del Personaje' : 'Character Name'}
                            </label>
                            <input type="text" id="memberCharacterName" class="form-control" placeholder="${lang === 'es' ? 'Nombre del personaje' : 'Character name'}" required onchange="generatePassword()">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label" style="color: var(--midnight-glow); font-weight: bold;">
                                <i class="fas fa-key"></i> ${lang === 'es' ? 'Contrase침a' : 'Password'}
                            </label>
                            <div class="input-group">
                                <input type="text" id="memberPassword" class="form-control" placeholder="${lang === 'es' ? 'Auto: nombre_pewpew' : 'Auto: name_pewpew'}" readonly style="background: rgba(138, 92, 246, 0.1);">
                                <button class="btn btn-outline-light" type="button" onclick="generatePassword()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <small style="color: var(--midnight-silver);">
                                ${lang === 'es' ? 'La contrase침a se genera autom치ticamente. El usuario podr치 cambiarla despu칠s.' : 'Password auto-generated. User can change it later.'}
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="color: var(--midnight-glow); font-weight: bold;">
                                <i class="fas fa-book"></i> ${lang === 'es' ? 'Clase' : 'Class'}
                            </label>
                            <select id="memberClass" class="form-select" required onchange="onClassChange()">
                                ${classOptions}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="color: var(--midnight-glow); font-weight: bold;">
                                <i class="fas fa-star"></i> ${lang === 'es' ? 'Especializaci칩n' : 'Specialization'}
                            </label>
                            <select id="memberSpec" class="form-select" required onchange="onSpecChange()" disabled>
                                <option value="">-- ${lang === 'es' ? 'Selecciona clase primero' : 'Select class first'} --</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="color: var(--midnight-glow); font-weight: bold;">
                                <i class="fas fa-shield-alt"></i> ${lang === 'es' ? 'Rol de Raid' : 'Raid Role'}
                            </label>
                            <select id="memberRole" class="form-select" required>
                                ${roleOptions}
                            </select>
                            <small style="color: var(--midnight-silver);">
                                ${lang === 'es' ? 'Se selecciona autom치ticamente seg칰n la especializaci칩n' : 'Auto-selected based on specialization'}
                            </small>
                        </div>
                    </div>
                </div>
            `;

            showModal({
                title: `<i class="fas fa-user-plus"></i> ${lang === 'es' ? 'A침adir Nuevo Miembro' : 'Add New Member'}`,
                body: modalBody,
                size: 'lg',
                buttons: [
                    { text: lang === 'es' ? 'Cancelar' : 'Cancel', variant: 'secondary', onClick: () => {} },
                    { text: lang === 'es' ? 'Crear Miembro' : 'Create Member', variant: 'primary', onClick: () => submitNewMember() }
                ]
            });
        }

        function submitNewMember() {
            const lang = localStorage.getItem('language') || 'es';

            const username = document.getElementById('memberUsername').value.trim();
            const characterName = document.getElementById('memberCharacterName').value.trim();
            const password = document.getElementById('memberPassword').value.trim();
            const characterClass = document.getElementById('memberClass').value;
            const spec = document.getElementById('memberSpec').value;
            const raidRole = document.getElementById('memberRole').value;

            // Validation
            if (!username || !characterName || !password || !characterClass || !spec || !raidRole) {
                showAlert(
                    lang === 'es' ? 'Por favor completa todos los campos' : 'Please fill all fields',
                    lang === 'es' ? 'Error' : 'Error',
                    'warning'
                );
                return;
            }

            // Call API to create user
            createNewMember(username, password, characterName, characterClass, raidRole, spec);
        }

        async function createNewMember(username, password, characterName, characterClass, raidRole, spec) {
            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/auth/register`, {
                    method: 'POST',
                    body: {
                        username,
                        password,
                        characterName,
                        characterClass,
                        raidRole,
                        spec
                    }
                });

                if (response && response.ok) {
                    showAlert(
                        lang === 'es' ? '춰Miembro creado exitosamente!' : 'Member created successfully!',
                        t('success', lang),
                        'success'
                    );
                    loadMembers();
                } else {
                    const error = await response.json();
                    showAlert(
                        lang === 'es' ? `Error: ${error.error}` : `Error: ${error.error}`,
                        t('error', lang),
                        'error'
                    );
                }
            } catch (error) {
                console.error('Error creating member:', error);
                showAlert(
                    lang === 'es' ? 'Error al crear miembro' : 'Error creating member',
                    t('error', lang),
                    'error'
                );
            }
        }

        // Mostrar modal para resetear contrase침a de un usuario (Admin only)
        async function showResetPasswordModal(userId, characterName) {
            const lang = localStorage.getItem('language') || 'es';

            const modalBody = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${lang === 'es'
                        ? `Vas a resetear la contrase침a de <strong>${characterName}</strong>`
                        : `You are about to reset the password for <strong>${characterName}</strong>`}
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-key"></i> ${lang === 'es' ? 'Nueva Contrase침a' : 'New Password'}
                        </label>
                        <input type="text" id="adminResetPassword" class="form-control" value="${characterName}_pewpew" required>
                        <small class="text-muted">
                            ${lang === 'es'
                                ? 'Por defecto: nombre_pewpew. El usuario puede cambiarla despu칠s.'
                                : 'Default: name_pewpew. User can change it later.'}
                        </small>
                    </div>
                </div>
            `;

            showModal({
                title: `<i class="fas fa-key"></i> ${lang === 'es' ? 'Resetear Contrase침a' : 'Reset Password'}`,
                body: modalBody,
                size: 'md',
                buttons: [
                    {
                        text: lang === 'es' ? 'Cancelar' : 'Cancel',
                        variant: 'secondary',
                        onClick: () => {} // Just closes
                    },
                    {
                        text: lang === 'es' ? 'Resetear Contrase침a' : 'Reset Password',
                        variant: 'warning',
                        onClick: () => submitPasswordReset(userId, characterName)
                    }
                ]
            });
        }

        async function submitPasswordReset(userId, characterName) {
            const lang = localStorage.getItem('language') || 'es';
            const newPassword = document.getElementById('adminResetPassword').value;

            if (!newPassword || newPassword.length < 6) {
                showAlert(
                    lang === 'es' ? 'La contrase침a debe tener al menos 6 caracteres' : 'Password must be at least 6 characters',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
                return;
            }

            try {
                const response = await fetchWithAuth(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId,
                        newPassword
                    })
                });

                if (response && response.ok) {
                    showAlert(
                        lang === 'es'
                            ? `춰Contrase침a de ${characterName} reseteada exitosamente!`
                            : `Password for ${characterName} reset successfully!`,
                        lang === 'es' ? '칄xito' : 'Success',
                        'success'
                    );
                } else {
                    const error = await response.json();
                    showAlert(
                        lang === 'es' ? `Error: ${error.error}` : `Error: ${error.error}`,
                        lang === 'es' ? 'Error' : 'Error',
                        'error'
                    );
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                showAlert(
                    lang === 'es' ? 'Error al resetear la contrase침a' : 'Error resetting password',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
            }
        }

        // Mostrar modal para cambiar contrase침a
        async function showChangePasswordModal() {
            const lang = localStorage.getItem('language') || 'es';

            const modalBody = `
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-lock"></i> ${lang === 'es' ? 'Contrase침a Actual' : 'Current Password'}
                        </label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-key"></i> ${lang === 'es' ? 'Nueva Contrase침a' : 'New Password'}
                        </label>
                        <input type="password" id="newPassword" class="form-control" required minlength="6">
                        <small class="text-muted">${lang === 'es' ? 'M칤nimo 6 caracteres' : 'Minimum 6 characters'}</small>
                    </div>
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-check-circle"></i> ${lang === 'es' ? 'Confirmar Nueva Contrase침a' : 'Confirm New Password'}
                        </label>
                        <input type="password" id="confirmPassword" class="form-control" required minlength="6">
                    </div>
                </div>
            `;

            showModal({
                title: `<i class="fas fa-key"></i> ${lang === 'es' ? 'Cambiar Contrase침a' : 'Change Password'}`,
                body: modalBody,
                size: 'md',
                buttons: [
                    {
                        text: lang === 'es' ? 'Cancelar' : 'Cancel',
                        variant: 'secondary',
                        onClick: () => {} // Just closes
                    },
                    {
                        text: lang === 'es' ? 'Cambiar Contrase침a' : 'Change Password',
                        variant: 'primary',
                        onClick: submitPasswordChange
                    }
                ]
            });
        }

        async function submitPasswordChange() {
            const lang = localStorage.getItem('language') || 'es';
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validaci칩n
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert(
                    lang === 'es' ? 'Por favor completa todos los campos' : 'Please fill all fields',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
                return;
            }

            if (newPassword.length < 6) {
                showAlert(
                    lang === 'es' ? 'La nueva contrase침a debe tener al menos 6 caracteres' : 'New password must be at least 6 characters',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert(
                    lang === 'es' ? 'Las contrase침as no coinciden' : 'Passwords do not match',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
                return;
            }

            try {
                const response = await fetchWithAuth(`${API_URL}/auth/change-password`, {
                    method: 'POST',
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                if (response && response.ok) {
                    showAlert(
                        lang === 'es' ? '춰Contrase침a actualizada exitosamente!' : 'Password updated successfully!',
                        lang === 'es' ? '칄xito' : 'Success',
                        'success'
                    );
                } else {
                    const error = await response.json();
                    showAlert(
                        lang === 'es' ? `Error: ${error.error}` : `Error: ${error.error}`,
                        lang === 'es' ? 'Error' : 'Error',
                        'error'
                    );
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showAlert(
                    lang === 'es' ? 'Error al cambiar la contrase침a' : 'Error changing password',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
            }
        }

        // Mostrar modal para crear subasta
        let selectedAuctionItem = null;
        let raidItemsCache = [];

        async function showCreateAuctionModal() {
            const lang = localStorage.getItem('language') || 'es';
            selectedAuctionItem = null;

            // Load raid items if not cached
            if (raidItemsCache.length === 0) {
                try {
                    const response = await fetchWithAuth(`${API_URL}/raid-items`);
                    const data = await response.json();
                    raidItemsCache = data.items;
                } catch (error) {
                    console.error('Error loading raid items:', error);
                    showAlert(lang === 'es' ? 'Error al cargar items de raid' : 'Error loading raid items', null, 'error');
                    return;
                }
            }

            const modalBody = `
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="itemSearch" class="form-control" placeholder="${lang === 'es' ? 'Buscar item, boss o raid...' : 'Search item, boss or raid...'}" oninput="filterAuctionItems()">
                </div>
                <div id="itemList" class="item-list">
                    ${renderItemList(raidItemsCache)}
                </div>
                <div id="selectedItemPreview" style="margin-top: 15px; padding: 15px; background: rgba(138, 92, 246, 0.1); border-radius: 8px; display: none;">
                    <h5 style="color: var(--midnight-glow); margin-bottom: 10px;">${lang === 'es' ? 'Item seleccionado:' : 'Selected item:'}</h5>
                    <div id="selectedItemInfo"></div>
                </div>
            `;

            showModal({
                title: lang === 'es' ? 'Crear Nueva Subasta' : 'Create New Auction',
                body: modalBody,
                size: 'lg',
                buttons: [
                    { text: lang === 'es' ? 'Cancelar' : 'Cancel', variant: 'secondary' },
                    {
                        text: lang === 'es' ? 'Crear Subasta' : 'Create Auction',
                        variant: 'primary',
                        onClick: () => createNewAuction(),
                        disabled: true,
                        icon: 'fas fa-gavel'
                    }
                ]
            });
        }

        function renderItemList(items, isFiltered = false) {
            const lang = localStorage.getItem('language') || 'es';

            // If filtered, show flat list without categories
            if (isFiltered) {
                if (items.length === 0) {
                    return `<p style="text-align: center; padding: 20px; color: var(--midnight-silver);">${lang === 'es' ? 'No se encontraron items' : 'No items found'}</p>`;
                }

                let html = '<div style="padding: 10px;">';
                items.forEach((item, index) => {
                    const iconUrl = `https://wow.zamimg.com/images/wow/icons/medium/${item.icon}.jpg`;
                    const itemName = typeof item.name === 'object' ? item.name[lang] : item.name;
                    // Find item index in original cache
                    const cacheIndex = raidItemsCache.findIndex(i => i.id === item.id);
                    html += `
                        <div class="item-entry" onclick="selectAuctionItemByIndex(${cacheIndex})">
                            <img src="${iconUrl}" class="item-icon" alt="${itemName}">
                            <div style="flex: 1;">
                                <span class="item-name item-rarity-${item.rarity}">${itemName}</span>
                                <div style="font-size: 0.75rem; color: var(--midnight-silver); margin-top: 2px;">
                                    <i class="fas fa-skull-crossbones"></i> ${item.boss} <span style="margin-left: 10px;"><i class="fas fa-dungeon"></i> ${item.raid}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                return html;
            }

            // Otherwise, show hierarchical view
            const groupedByRaid = {};
            items.forEach(item => {
                if (!groupedByRaid[item.raid]) {
                    groupedByRaid[item.raid] = {};
                }
                if (!groupedByRaid[item.raid][item.boss]) {
                    groupedByRaid[item.raid][item.boss] = [];
                }
                groupedByRaid[item.raid][item.boss].push(item);
            });

            let html = '';
            Object.entries(groupedByRaid).forEach(([raidName, bosses]) => {
                html += `
                    <div class="item-category" onclick="toggleCategory(this)">
                        <span><i class="fas fa-dungeon"></i> ${raidName}</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="category-content" style="display: none;">
                `;

                Object.entries(bosses).forEach(([bossName, bossItems]) => {
                    html += `<div style="padding-left: 20px;">`;
                    html += `
                        <div class="item-category" style="background: rgba(138, 92, 246, 0.15); font-size: 0.9rem;" onclick="toggleCategory(this)">
                            <span><i class="fas fa-skull-crossbones"></i> ${bossName}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="category-content" style="display: none;">
                    `;

                    bossItems.forEach(item => {
                        const iconUrl = `https://wow.zamimg.com/images/wow/icons/medium/${item.icon}.jpg`;
                        const itemName = typeof item.name === 'object' ? item.name[lang] : item.name;
                        // Find item index in original cache
                        const cacheIndex = raidItemsCache.findIndex(i => i.id === item.id);
                        html += `
                            <div class="item-entry" onclick="selectAuctionItemByIndex(${cacheIndex})">
                                <img src="${iconUrl}" class="item-icon" alt="${itemName}">
                                <span class="item-name item-rarity-${item.rarity}">${itemName}</span>
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                });

                html += `</div>`;
            });

            return html || `<p style="text-align: center; padding: 20px; color: var(--midnight-silver);">${lang === 'es' ? 'No se encontraron items' : 'No items found'}</p>`;
        }

        function toggleCategory(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.fa-chevron-down, .fa-chevron-up');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                content.style.display = 'none';
                if (icon) icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }

        function selectAuctionItemByIndex(index) {
            if (index >= 0 && index < raidItemsCache.length) {
                selectAuctionItem(raidItemsCache[index]);
            }
        }

        function selectAuctionItem(item) {
            const lang = localStorage.getItem('language') || 'es';
            selectedAuctionItem = item;

            // Remove previous selection
            document.querySelectorAll('.item-entry.selected').forEach(el => el.classList.remove('selected'));

            // Add selection to clicked item
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }

            // Show preview
            const preview = document.getElementById('selectedItemPreview');
            const iconUrl = `https://wow.zamimg.com/images/wow/icons/medium/${item.icon}.jpg`;
            const itemName = typeof item.name === 'object' ? item.name[lang] : item.name;
            document.getElementById('selectedItemInfo').innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="${iconUrl}" style="width: 48px; height: 48px; border-radius: 8px; border: 2px solid var(--midnight-bright-purple);" alt="${itemName}">
                    <div>
                        <div class="item-rarity-${item.rarity}" style="font-size: 1.2rem; font-weight: bold;">${itemName}</div>
                        <div style="font-size: 0.9rem; color: var(--midnight-silver); opacity: 0.8;">
                            ${item.boss} - ${item.raid}
                        </div>
                    </div>
                </div>
            `;
            preview.style.display = 'block';

            // Enable create button
            const buttons = document.querySelectorAll('.custom-modal-footer .btn-primary');
            buttons.forEach(btn => btn.disabled = false);
        }

        function filterAuctionItems() {
            const searchInput = document.getElementById('itemSearch');
            const query = searchInput.value.toLowerCase();
            const lang = localStorage.getItem('language') || 'es';

            if (query === '') {
                document.getElementById('itemList').innerHTML = renderItemList(raidItemsCache, false);
                return;
            }

            const filtered = raidItemsCache.filter(item => {
                const itemName = typeof item.name === 'object' ? (item.name[lang] || item.name.en) : item.name;
                return itemName.toLowerCase().includes(query) ||
                       item.boss.toLowerCase().includes(query) ||
                       item.raid.toLowerCase().includes(query);
            });

            document.getElementById('itemList').innerHTML = renderItemList(filtered, true);
        }

        async function createNewAuction() {
            const lang = localStorage.getItem('language') || 'es';

            if (!selectedAuctionItem) {
                showAlert(lang === 'es' ? 'Por favor selecciona un item' : 'Please select an item', null, 'warning');
                return;
            }

            try {
                const iconUrl = `https://wow.zamimg.com/images/wow/icons/medium/${selectedAuctionItem.icon}.jpg`;

                // Get item name - handle both old format (string) and new format (object with translations)
                let itemNameES, itemNameEN;
                if (typeof selectedAuctionItem.name === 'object') {
                    itemNameES = selectedAuctionItem.name.es;
                    itemNameEN = selectedAuctionItem.name.en;
                } else {
                    // Old format - use same name for both
                    itemNameES = selectedAuctionItem.name;
                    itemNameEN = selectedAuctionItem.name;
                }

                const response = await fetchWithAuth(`${API_URL}/auctions`, {
                    method: 'POST',
                    body: {
                        itemName: itemNameES, // Primary name in Spanish
                        itemNameEN: itemNameEN, // English name for translation
                        minBid: 0,
                        itemRarity: selectedAuctionItem.rarity,
                        itemImage: iconUrl
                    }
                });

                if (response && response.ok) {
                    showAlert(
                        lang === 'es' ? '춰Subasta creada exitosamente!' : 'Auction created successfully!',
                        lang === 'es' ? '칄xito' : 'Success',
                        'success'
                    );
                    loadActiveAuctions();
                } else {
                    const error = await response.json();
                    showAlert(error.error, lang === 'es' ? 'Error' : 'Error', 'error');
                }
            } catch (error) {
                console.error('Error creating auction:', error);
                showAlert(
                    lang === 'es' ? 'Error al crear subasta' : 'Error creating auction',
                    lang === 'es' ? 'Error' : 'Error',
                    'error'
                );
            }
        }

        // ======================================
        // CALENDAR FUNCTIONS
        // ======================================
        let currentWeekStart = null;

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function initCalendar() {
            const today = new Date();
            currentWeekStart = formatDate(getMonday(today));
            loadCalendarAvailability();
        }

        async function loadCalendarAvailability() {
            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/calendar/my-availability/${currentWeekStart}`);
                const availability = await response.json();

                // Store availability data
                calendarAvailabilityData = availability;

                // Update week display
                const weekDate = new Date(currentWeekStart);
                const weekDisplay = document.getElementById('currentWeekDisplay');
                if (weekDisplay) {
                    weekDisplay.textContent = weekDate.toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US');
                }

                // Render calendar based on current view
                renderCurrentCalendarView();

                // Load admin attendance if user is admin/officer
                const user = JSON.parse(localStorage.getItem('user'));
                if (user && ['admin', 'officer'].includes(user.role)) {
                    loadAdminAttendance();
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        let currentCalendarView = 'option1';
        let calendarAvailabilityData = [];

        function changeCalendarView() {
            currentCalendarView = document.getElementById('calendarViewSelector').value;
            renderCurrentCalendarView();
        }

        function renderCurrentCalendarView() {
            if (currentCalendarView === 'option1') {
                document.getElementById('calendarOption1').style.display = 'block';
                document.getElementById('calendarOption2').style.display = 'none';
                renderWeekView(calendarAvailabilityData);
            } else {
                document.getElementById('calendarOption1').style.display = 'none';
                document.getElementById('calendarOption2').style.display = 'block';
                renderCardView(calendarAvailabilityData);
            }
        }

        // OPCI칍N 1: Week View
        function renderWeekView(availability) {
            const lang = localStorage.getItem('language') || 'es';
            const grid = document.getElementById('weekDaysGrid1');

            let html = '';
            availability.forEach(day => {
                const statusClass = day.status || '';
                const icon = day.status === 'confirmed' ? 'fa-check-circle' :
                            day.status === 'declined' ? 'fa-times-circle' :
                            day.status === 'tentative' ? 'fa-question-circle' : 'fa-calendar';

                const statusText = day.status === 'confirmed' ? t('confirmed', lang) :
                                  day.status === 'declined' ? t('declined', lang) :
                                  day.status === 'tentative' ? t('tentative', lang) :
                                  lang === 'es' ? 'Click para confirmar' : 'Click to confirm';

                html += `
                    <div class="week-day-card ${statusClass}" onclick="quickConfirmDay(${day.dayOfWeek})">
                        <div class="week-day-badge">${day.dayName}</div>
                        <div class="week-day-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="week-day-status">${statusText}</div>
                        ${day.status === 'confirmed' ? `<div class="week-day-dkp-badge">+1 DKP</div>` : ''}
                        <div style="font-size: 0.9rem; color: var(--midnight-silver); margin-top: 10px;">
                            <i class="fas fa-clock"></i> ${day.raidTime}
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
            updateDKPProgress(availability);
        }

        // OPCI칍N 2: Card View
        function renderCardView(availability) {
            const lang = localStorage.getItem('language') || 'es';
            const grid = document.getElementById('raidCardsGrid2');

            let html = '';
            availability.forEach(day => {
                html += `
                    <div class="raid-day-card">
                        <div class="raid-card-header">
                            <div class="raid-day-badge-large">${day.dayName.substring(0, 3).toUpperCase()}</div>
                            <div class="raid-time-display">
                                <i class="fas fa-clock"></i> ${day.raidTime}
                            </div>
                        </div>
                        <div class="raid-action-buttons">
                            <button class="raid-action-btn btn-confirm ${day.status === 'confirmed' ? 'active' : ''}"
                                    onclick="updateAvailability(${day.dayOfWeek}, 'confirmed')">
                                <i class="fas fa-check-circle"></i>
                                <span>${t('confirmed', lang)}</span>
                                <span class="dkp-indicator">+1 DKP</span>
                            </button>
                            <button class="raid-action-btn btn-tentative ${day.status === 'tentative' ? 'active' : ''}"
                                    onclick="updateAvailability(${day.dayOfWeek}, 'tentative')">
                                <i class="fas fa-question-circle"></i>
                                <span>${t('tentative', lang)}</span>
                            </button>
                            <button class="raid-action-btn btn-decline ${day.status === 'declined' ? 'active' : ''}"
                                    onclick="updateAvailability(${day.dayOfWeek}, 'declined')">
                                <i class="fas fa-times-circle"></i>
                                <span>${t('declined', lang)}</span>
                            </button>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
            updateDKPProgress(availability);
        }

        function quickConfirmDay(dayOfWeek) {
            updateAvailability(dayOfWeek, 'confirmed');
        }

        function updateDKPProgress(availability) {
            const confirmedDays = availability.filter(d => d.status === 'confirmed').length;
            const totalDays = availability.length;
            const dkpEarned = confirmedDays;

            const progressBar = document.getElementById('dkpProgressBar');
            const progressText = document.getElementById('progressText');
            const weeklyDKPEarned = document.getElementById('weeklyDKPEarned');
            const lang = localStorage.getItem('language') || 'es';

            const percentage = (confirmedDays / totalDays) * 100;
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', confirmedDays);
            progressText.textContent = `${confirmedDays}/${totalDays}`;
            weeklyDKPEarned.innerHTML = `${dkpEarned} DKP <span data-i18n="earned">${lang === 'es' ? 'ganados' : 'earned'}</span>`;
        }

        async function updateAvailability(dayOfWeek, status) {
            const lang = localStorage.getItem('language') || 'es';
            const notes = document.getElementById(`notes_${dayOfWeek}`)?.value || '';

            try {
                const response = await fetchWithAuth(`${API_URL}/calendar/availability`, {
                    method: 'PUT',
                    body: {
                        week_start: currentWeekStart,
                        day_of_week: dayOfWeek,
                        status,
                        notes
                    }
                });

                const result = await response.json();

                if (result.completed && result.dkpAwarded > 0) {
                    const message = t('dkp_bonus_earned', lang).replace('{amount}', result.dkpAwarded);
                    showAlert(
                        `${t('calendar_completed', lang)}\n\n${message}`,
                        '游꿀 ' + t('success', lang),
                        'success'
                    );
                    loadUserData(); // Refresh DKP
                } else {
                    // Just show success message
                    console.log(t('availability_updated', lang));
                }

                // Reload calendar
                loadCalendarAvailability();
            } catch (error) {
                console.error('Error updating availability:', error);
                showAlert(t('error', lang), t('error', lang), 'error');
            }
        }

        async function loadWeekOverview() {
            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/calendar/week-overview/${currentWeekStart}`);
                const overview = await response.json();

                renderWeekOverview(overview);
            } catch (error) {
                console.error('Error loading week overview:', error);
            }
        }

        function renderWeekOverview(overview) {
            const lang = localStorage.getItem('language') || 'es';
            const container = document.getElementById('weekOverview');

            // Summary cards
            let summaryHtml = '<div class="row mb-3">';
            overview.raidDays.forEach(day => {
                summaryHtml += `
                    <div class="col-md-4 mb-2">
                        <div class="day-summary">
                            <div class="summary-count">${day.confirmed}</div>
                            <div class="summary-label">${day.dayName} - ${t('players_confirmed', lang)}</div>
                        </div>
                    </div>
                `;
            });
            summaryHtml += '</div>';

            // Members table
            let tableHtml = `
                <div class="week-overview-grid">
                    <table class="week-overview-table">
                        <thead>
                            <tr>
                                <th>${t('character', lang)}</th>
                                <th>${t('role', lang)}</th>
            `;

            overview.raidDays.forEach(day => {
                tableHtml += `<th>${day.dayName}</th>`;
            });

            tableHtml += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            overview.members.forEach(member => {
                tableHtml += `
                    <tr>
                        <td><strong style="color: ${getClassColor(member.characterClass)};">${member.characterName}</strong></td>
                        <td>${member.raidRole || 'DPS'}</td>
                `;

                overview.raidDays.forEach(day => {
                    const status = member.availability[day.dayOfWeek] || 'no_response';
                    const statusText = t(status.replace('_', ''), lang);
                    tableHtml += `<td><span class="status-badge ${status.replace('_', '-')}">${statusText}</span></td>`;
                });

                tableHtml += '</tr>';
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = summaryHtml + tableHtml;
        }

        function loadPreviousWeek() {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() - 7);
            currentWeekStart = formatDate(date);
            loadCalendarAvailability();
        }

        function loadNextWeek() {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + 7);
            currentWeekStart = formatDate(date);
            loadCalendarAvailability();
        }
        // ======================================
        // ADMIN ATTENDANCE FUNCTIONS
        // ======================================
        let adminWeekStart = null;
        let adminAttendanceData = null;

        async function loadAdminAttendance() {
            if (!adminWeekStart) {
                adminWeekStart = currentWeekStart;
            }

            const lang = localStorage.getItem('language') || 'es';
            try {
                const response = await fetchWithAuth(`${API_URL}/calendar/week-overview/${adminWeekStart}`);
                adminAttendanceData = await response.json();

                // Update week display
                const weekDate = new Date(adminWeekStart);
                const adminWeekDisplay = document.getElementById('adminWeekDisplay');
                if (adminWeekDisplay) {
                    adminWeekDisplay.textContent = weekDate.toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US');
                }

                renderAdminAttendanceTable();
            } catch (error) {
                console.error('Error loading admin attendance:', error);
            }
        }

        function renderAdminAttendanceTable() {
            if (!adminAttendanceData) return;

            const lang = localStorage.getItem('language') || 'es';
            const tbody = document.getElementById('attendanceTableBody');
            const filter = document.getElementById('attendanceFilter')?.value || 'all';

            let html = '';

            adminAttendanceData.members.forEach(member => {
                // Calculate DKP earned (count confirmed days)
                let dkpEarned = 0;
                const dayStatuses = [];

                adminAttendanceData.raidDays.forEach(day => {
                    const status = member.availability[day.dayOfWeek] || 'no_response';
                    dayStatuses.push(status);
                    if (status === 'confirmed') {
                        dkpEarned++;
                    }
                });

                // Apply filter
                if (filter !== 'all') {
                    const hasFilteredStatus = dayStatuses.some(status => {
                        if (filter === 'confirmed') return status === 'confirmed';
                        if (filter === 'declined') return status === 'declined';
                        if (filter === 'no_response') return status === 'no_response';
                        return false;
                    });
                    if (!hasFilteredStatus) return;
                }

                // Get class info
                const classColor = getClassColor(member.characterClass);
                const classIcon = getClassIcon(member.characterClass);
                const roleIcon = getRoleIcon(member.raidRole || 'DPS');

                html += `
                    <tr>
                        <td>
                            <img src="${classIcon}" alt="${member.characterClass}" style="width: 18px; height: 18px; margin-right: 5px; vertical-align: middle; border-radius: 3px;">
                            <strong style="color: ${classColor};">${member.characterName}</strong>
                        </td>
                        <td>${member.characterClass || '-'}</td>
                        <td>
                            <img src="${roleIcon}" alt="${member.raidRole}" style="width: 16px; height: 16px; margin-right: 3px; vertical-align: middle;">
                            ${member.raidRole || 'DPS'}
                        </td>
                `;

                // Add day columns
                adminAttendanceData.raidDays.forEach(day => {
                    const status = member.availability[day.dayOfWeek] || 'no_response';
                    const icon = status === 'confirmed' ? '<i class="fas fa-check-circle text-success"></i>' :
                                status === 'declined' ? '<i class="fas fa-times-circle text-danger"></i>' :
                                status === 'tentative' ? '<i class="fas fa-question-circle text-warning"></i>' :
                                '<i class="fas fa-minus text-muted"></i>';

                    html += `<td style="text-align: center;">${icon}</td>`;
                });

                // Notes and DKP columns
                html += `
                        <td style="font-size: 0.85rem; color: #aaa;">-</td>
                        <td style="text-align: center;"><strong>${dkpEarned}</strong></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || `<tr><td colspan="8" class="text-center">${lang === 'es' ? 'No hay datos' : 'No data'}</td></tr>`;
        }

        function loadAdminPreviousWeek() {
            const date = new Date(adminWeekStart);
            date.setDate(date.getDate() - 7);
            adminWeekStart = formatDate(date);
            loadAdminAttendance();
        }

        function loadAdminNextWeek() {
            const date = new Date(adminWeekStart);
            date.setDate(date.getDate() + 7);
            adminWeekStart = formatDate(date);
            loadAdminAttendance();
        }

        function filterAttendance() {
            renderAdminAttendanceTable();
        }

        // ======================================
        // INICIALIZACI칍N
        // ======================================
        window.addEventListener('load', function() {
            console.log('%c游깿 MIDNIGHT EDITION', 'color: #a78bfa; font-size: 24px; font-weight: bold; font-family: Cinzel, serif');
            initLanguage();
            loadUserData();
            connectSocket();
            loadMembers();
            loadAuctionsHistory();
            initCalendar();
        });
        
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>

    <!-- Modal Container -->
    <div id="modalContainer"></div>
</body>
</html>
