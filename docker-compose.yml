# =============================================
# DKP System - Docker Compose Configuration
# =============================================
# 
# Usage:
#   Development:  docker-compose up
#   Production:   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Build:        docker-compose build
#   Logs:         docker-compose logs -f
#   Stop:         docker-compose down
#   Reset DB:     docker-compose down -v && docker-compose up
#

services:
  # =============================================
  # Backend API Server
  # =============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dkp-backend
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - DATABASE_PATH=/app/data/dkp.db
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      - WARCRAFTLOGS_CLIENT_ID=${WARCRAFTLOGS_CLIENT_ID}
      - WARCRAFTLOGS_CLIENT_SECRET=${WARCRAFTLOGS_CLIENT_SECRET}
    volumes:
      # Persist SQLite database
      - dkp-data:/app/data
      # For development: mount source for hot reload
      # Uncomment these lines for development:
      # - ./server.js:/app/server.js:ro
      # - ./database.js:/app/database.js:ro
      # - ./middleware:/app/middleware:ro
      # - ./utils:/app/utils:ro
      # - ./tasks:/app/tasks:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - dkp-network

  # =============================================
  # Frontend (opcional - descomenta si lo necesitas)
  # =============================================
  # frontend:
  #   build:
  #     context: ../dkp-frontend
  #     dockerfile: Dockerfile
  #   container_name: dkp-frontend
  #   restart: unless-stopped
  #   ports:
  #     - "5173:80"
  #   environment:
  #     - VITE_API_URL=http://backend:3000
  #   depends_on:
  #     - backend
  #   networks:
  #     - dkp-network

# =============================================
# Volumes for data persistence
# =============================================
volumes:
  dkp-data:
    driver: local

# =============================================
# Networks
# =============================================
networks:
  dkp-network:
    driver: bridge
